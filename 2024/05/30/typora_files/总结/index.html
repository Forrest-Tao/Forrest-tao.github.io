

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Forrest">
  <meta name="keywords" content="">
  
    <meta name="description" content="goday0昨日2024.3.2 顺利到达上海。今日租到了房，2.1K &#x2F; mon。花销 2100*2(房租)+ 400（服务费）+ 100+的日常用品（洗发水+沐浴露+被子+饮用水+雨伞+面包+香蕉+垃圾桶） 共 4700+ day1忙碌的一天。 今天是实习的第一天  安装软件和各种配置 leetcode两个题目 参与了第一次的组会，感受到了压力  day2账号密码账号：yansait">
<meta property="og:type" content="article">
<meta property="og:title" content="Forrest’s blog">
<meta property="og:url" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="Forrest’s blog">
<meta property="og:description" content="goday0昨日2024.3.2 顺利到达上海。今日租到了房，2.1K &#x2F; mon。花销 2100*2(房租)+ 400（服务费）+ 100+的日常用品（洗发水+沐浴露+被子+饮用水+雨伞+面包+香蕉+垃圾桶） 共 4700+ day1忙碌的一天。 今天是实习的第一天  安装软件和各种配置 leetcode两个题目 参与了第一次的组会，感受到了压力  day2账号密码账号：yansait">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/day2.assets/image-20240305142809192.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/Users/admin/AppData/Roaming/Typora/typora-user-images/image-20240305111646927.png">
<meta property="og:image" content="https://pic2.zhimg.com/80/v2-7f17c802b35ab3834230fd53e10e35ad_720w.webp">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/day2.assets/image-20240306104518229.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240311102818874.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240311113903356.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240311140640873.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240311155855593.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240311144112007.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240311160257935.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240314103447772.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240314185559915.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240316145128673.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240316192133547.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240316201236366.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240318151103611.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240321155800311.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240321160134069.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240321160224013.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240321191903717.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240322214848385.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240325184358948.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240328223307381.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240330095834566.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240329090004923.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240329093557221.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240330151211692.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240401142545601.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240401150734601.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240401161531467.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240401164214273.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240402175501876.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240403160339310.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240402222659415.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240407150626033.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240408144054642.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240408144825855.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240408153513773.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240408173841848.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240408175641106.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409102330419.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409113823238.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409152604658.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409154413964.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409154418555.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409161041776.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409173428330.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409181959419.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409192900548.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409201935824.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240409204407112.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240412111758349.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240412111859483.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240412111915627.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240413192459459.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240417205428225.png">
<meta property="og:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/%E6%80%BB%E7%BB%93.assets/image-20240418105135696.png">
<meta property="article:published_time" content="2024-05-30T02:22:27.369Z">
<meta property="article:modified_time" content="2024-04-24T14:19:10.928Z">
<meta property="article:author" content="Forrest">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files/day2.assets/image-20240305142809192.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Forrest’s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Forrest</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text=""></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-05-30 10:22" pubdate>
          2024年5月30日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          89k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          297 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header"></h1>
            
            
              <div class="markdown-body">
                
                <h2 id="go"><a href="#go" class="headerlink" title="go"></a>go</h2><h2 id="day0"><a href="#day0" class="headerlink" title="day0"></a>day0</h2><p>昨日2024.3.2 顺利到达上海。今日租到了房，2.1K &#x2F; mon。花销 2100*2(房租)+ 400（服务费）+ 100+的日常用品（洗发水+沐浴露+被子+饮用水+雨伞+面包+香蕉+垃圾桶） 共 4700+</p>
<h2 id="day1"><a href="#day1" class="headerlink" title="day1"></a>day1</h2><p>忙碌的一天。</p>
<p>今天是实习的第一天</p>
<ul>
<li>安装软件和各种配置</li>
<li>leetcode两个题目</li>
<li>参与了第一次的组会，感受到了压力</li>
</ul>
<h2 id="day2"><a href="#day2" class="headerlink" title="day2"></a>day2</h2><h3 id="账号密码"><a href="#账号密码" class="headerlink" title="账号密码"></a>账号密码</h3><p>账号：yansaitao</p>
<p>密码：nxqND8jRLthq</p>
<h3 id="git的提交流程"><a href="#git的提交流程" class="headerlink" title="git的提交流程"></a>git的提交流程</h3><h4 id="单项目"><a href="#单项目" class="headerlink" title="单项目"></a>单项目</h4><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\day2.assets\image-20240305142809192.png" srcset="/img/loading.gif" lazyload alt="image-20240305142809192"></p>
<h4 id="多项目"><a href="#多项目" class="headerlink" title="多项目"></a>多项目</h4><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240305111646927.png" srcset="/img/loading.gif" lazyload alt="image-20240305111646927"></p>
<h3 id="go-的proxy"><a href="#go-的proxy" class="headerlink" title="go 的proxy"></a>go 的proxy</h3><p>go proxy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 启用 Go Modules 功能</span><br>go <span class="hljs-built_in">env</span> -w GO111MODULE=on<br><br><span class="hljs-comment"># 配置 GOPROXY 环境变量，以下三选一</span><br><br><span class="hljs-comment"># 1. 七牛 CDN</span><br>go <span class="hljs-built_in">env</span> -w  GOPROXY=https://goproxy.cn,direct<br><br><span class="hljs-comment"># 2. 阿里云</span><br>go <span class="hljs-built_in">env</span> -w GOPROXY=https://mirrors.aliyun.com/goproxy/,direct<br><br><span class="hljs-comment"># 3. 官方</span><br>go <span class="hljs-built_in">env</span> -w  GOPROXY=https://goproxy.io,direct<br></code></pre></td></tr></table></figure>





<p>git pull 用于从远程获取代码&amp;&amp;合并代码</p>
<h3 id="配置git的信息"><a href="#配置git的信息" class="headerlink" title="配置git的信息"></a>配置git的信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br>git config --global user.name <span class="hljs-string">&quot;yansaitao</span><br><span class="hljs-string"></span><br><span class="hljs-string">git config --global user.email yansaitao@songshuai.com</span><br><span class="hljs-string"></span><br><span class="hljs-string">git config --global --list</span><br><span class="hljs-string"></span><br><span class="hljs-string">// 生成密钥 </span><br><span class="hljs-string">ssh-keygen -t rsa</span><br><span class="hljs-string">//默认的位置是 默认是C:\Users\当前用户名\.ssh</span><br></code></pre></td></tr></table></figure>



<p><img src="https://pic2.zhimg.com/80/v2-7f17c802b35ab3834230fd53e10e35ad_720w.webp" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="goctl-protoc安装"><a href="#goctl-protoc安装" class="headerlink" title="goctl&amp;&amp;protoc安装"></a>goctl&amp;&amp;protoc安装</h3><ul>
<li><p>如果 go 版本在 <code>1.16</code> 及以后，则使用如下命令安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ GO111MODULE=on go install github.com/zeromicro/go-zero/tools/goctl@latest<br></code></pre></td></tr></table></figure>
</li>
<li><p>打开终端输入如下命令来验证是否安装成功：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ goctl --version<br></code></pre></td></tr></table></figure>
</li>
<li><p>自动安装protoc系列工具</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">goctl <span class="hljs-built_in">env</span> check --verbose --install --force<br></code></pre></td></tr></table></figure>
</li>
<li><p>验证protoc系列工具</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">goctl <span class="hljs-built_in">env</span> check --verbose<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="api-文件"><a href="#api-文件" class="headerlink" title="api 文件"></a>api 文件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">syntax =<span class="hljs-string">&quot;v1&quot;</span><br><br><span class="hljs-keyword">type</span> (<br>    LoginReq&#123;<br>        UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;username&quot;`</span><br>        Password <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;password&quot;`</span><br>    &#125;<br>    LoginResp&#123;<br>        Id <span class="hljs-type">int64</span> <span class="hljs-string">`json:&quot;id&quot;`</span><br>        Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>        Token <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;token&quot;`</span><br>    &#125;<br>)<br><br>@server (<br>    group :login<br>    prefix : /v1<br>    middleware :AuthInterceptor<br>    timeout : <span class="hljs-number">3</span>s<br>    maxBytes : <span class="hljs-number">10000</span><br>)<br>service user&#123;<br>    @handler login<br>    post /user/login (LoginReq)returns(LoginResp)<br>&#125;<br></code></pre></td></tr></table></figure>





<p><strong>log 有问题</strong></p>
<p>dockerfile 的 APP_ENV</p>
<h2 id="day3"><a href="#day3" class="headerlink" title="day3"></a>day3</h2><h3 id="go-zero的熟悉"><a href="#go-zero的熟悉" class="headerlink" title="go-zero的熟悉"></a>go-zero的熟悉</h3><h4 id="api-框架的生成"><a href="#api-框架的生成" class="headerlink" title="api 框架的生成"></a>api 框架的生成</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">goctl api new demo<br></code></pre></td></tr></table></figure>

<h4 id="mysql代码生成"><a href="#mysql代码生成" class="headerlink" title="mysql代码生成"></a>mysql代码生成</h4><ul>
<li><p>创建 model层，model层中放user.sql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE user (<br>    id bigint AUTO_INCREMENT,<br>    name varchar(255) NULL COMMENT &#x27;The username&#x27;,<br>    password varchar(255) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;The user password&#x27;,<br>    mobile varchar(255) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;The mobile phone number&#x27;,<br>    gender char(10) NOT NULL DEFAULT &#x27;male&#x27; COMMENT &#x27;gender,male|female|unknown&#x27;,<br>    nickname varchar(255) NULL DEFAULT &#x27;&#x27; COMMENT &#x27;The nickname&#x27;,<br>    type tinyint(1) NULL DEFAULT 0 COMMENT &#x27;The user type, 0:normal,1:vip, for test golang keyword&#x27;,<br>    create_at timestamp NULL,<br>    update_at timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,<br>    UNIQUE mobile_index (mobile),<br>    UNIQUE name_index (name),<br>    PRIMARY KEY (id)<br>) ENGINE = InnoDB COLLATE utf8mb4_general_ci COMMENT &#x27;user table&#x27;;<br></code></pre></td></tr></table></figure>
</li>
<li><p>利用框架生成sqlx的代码</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\day2.assets\image-20240306104518229.png" srcset="/img/loading.gif" lazyload alt="image-20240306104518229"></p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">goctl model mysql ddl --src user.sql --<span class="hljs-built_in">dir</span> .<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="格式化api文件"><a href="#格式化api文件" class="headerlink" title="格式化api文件"></a>格式化api文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">goctl api format -<span class="hljs-built_in">dir</span> .<br></code></pre></td></tr></table></figure>

<h4 id="按照指定的api文件生成代码"><a href="#按照指定的api文件生成代码" class="headerlink" title="按照指定的api文件生成代码"></a>按照指定的api文件生成代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">goctl api go -api greet.api -<span class="hljs-built_in">dir</span> greet<br></code></pre></td></tr></table></figure>

<h4 id="mapreduce"><a href="#mapreduce" class="headerlink" title="mapreduce"></a>mapreduce</h4><p>日志的格式</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">ctx := logx.ContextWithFields(context.Background(), logx.Field(<span class="hljs-string">&quot;path&quot;</span>, <span class="hljs-string">&quot;/user/info&quot;</span>))<br><br>logc.Infow(ctx, <span class="hljs-string">&quot;hello world&quot;</span>)<br>logc.Error(ctx, <span class="hljs-string">&quot;error log&quot;</span>)<br><span class="hljs-comment">// &#123;&quot;@timestamp&quot;:&quot;2023-04-22T20:53:00.593+08:00&quot;,&quot;caller&quot;:&quot;inherit/main.go:13&quot;,&quot;content&quot;:&quot;hello world&quot;,&quot;level&quot;:&quot;info&quot;,&quot;path&quot;:&quot;/user/info&quot;&#125;</span><br><span class="hljs-comment">// &#123;&quot;@timestamp&quot;:&quot;2023-04-22T20:53:00.593+08:00&quot;,&quot;caller&quot;:&quot;inherit/main.go:14&quot;,&quot;content&quot;:&quot;error log&quot;,&quot;level&quot;:&quot;error&quot;,&quot;path&quot;:&quot;/user/info&quot;&#125;</span><br></code></pre></td></tr></table></figure>

<p>timestamp + caller(日志出现的文件位置+调用行数)+content+key&amp;&amp;Value对+日志的级别</p>
<h4 id="token-中的-claim字段"><a href="#token-中的-claim字段" class="headerlink" title="token 中的 claim字段"></a>token 中的 claim字段</h4><p>通常情况下，claim 可以分为三种类型：</p>
<ol>
<li><strong>注册声明（Registered Claims）</strong>：这些是已经定义好的一些标准声明，包括：<ul>
<li>iss：令牌的签发者（issuer）</li>
<li>sub：令牌的主题（subject）</li>
<li>aud：令牌的受众（audience）</li>
<li>exp：令牌的过期时间（expiration time）</li>
<li>nbf：令牌的生效时间（not before）</li>
<li>iat：令牌的签发时间（issued at）</li>
<li>jti：令牌的唯一标识（JWT ID）</li>
</ul>
</li>
<li><strong>公开声明（Public Claims）</strong>：这些是自定义的声明，可以根据需要添加到令牌中，以传递任何与令牌相关的信息，如用户角色、权限、访问级别等。</li>
</ol>
<h3 id="wiki的各种规范"><a href="#wiki的各种规范" class="headerlink" title="wiki的各种规范"></a>wiki的各种规范</h3><h3 id="go-zero-的流量限制"><a href="#go-zero-的流量限制" class="headerlink" title="go-zero 的流量限制"></a>go-zero 的流量限制</h3><ul>
<li>win hey压测的安装 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/wintersun/p/12492096.html">轻量级压测工具hey介绍与实践 - PetterLiu - 博客园 (cnblogs.com)</a></li>
</ul>
<p>503 Service Unavailable 是一种HTTP 协议的服务器端错误状态代码，它<strong>表示服务器尚未处于可以接受请求的状态</strong>。</p>
<h2 id="day4"><a href="#day4" class="headerlink" title="day4"></a>day4</h2><p>系统的架构</p>
<p>rabitMQ</p>
<p>项目kafka运转原理</p>
<p>配置中心</p>
<h3 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h3><p>内网或外网</p>
<p>ingress</p>
<h2 id="day5"><a href="#day5" class="headerlink" title="day5"></a>day5</h2><p>看go-zero的log日志，构思日志的写法 failed。。。</p>
<h2 id="todolist"><a href="#todolist" class="headerlink" title="todolist"></a>todolist</h2><ul>
<li><input checked disabled type="checkbox"> 周末和军哥看上海外滩</li>
<li><input checked disabled type="checkbox"> 原本周天的模拟面试改周六</li>
<li><input checked disabled type="checkbox"> 下午的计算机网络</li>
<li><input disabled type="checkbox"> kafka的搭建+代码运行 topic partition producer consumer</li>
<li><input disabled type="checkbox"> lua 脚本</li>
<li><input checked disabled type="checkbox"> utils包的代码</li>
<li><input disabled type="checkbox"> 加密算法（）</li>
<li><input disabled type="checkbox"> 限流中间件</li>
<li><input checked disabled type="checkbox"> 入参出参的日志的记录（自定义定义一个中间件）   call time traceId </li>
<li><input checked disabled type="checkbox"> 本地日志改udp日志</li>
<li><input checked disabled type="checkbox"> io.Reader 的重复读问题</li>
<li><input checked disabled type="checkbox"> copilot 试用</li>
<li><input disabled type="checkbox"> go的测试</li>
<li><input checked disabled type="checkbox"> 学习通</li>
<li><input disabled type="checkbox"> env</li>
<li><input checked disabled type="checkbox"> UDP端口号申请</li>
<li><input checked disabled type="checkbox"> 代码env的环境</li>
<li><input checked disabled type="checkbox"> 提测</li>
<li><input checked disabled type="checkbox"> 周报</li>
<li><input disabled type="checkbox"> 业务数据导入</li>
<li><input disabled type="checkbox"> 建表</li>
<li><input disabled type="checkbox"> msg_doc 文档编写</li>
<li><input disabled type="checkbox"> 单元测试</li>
<li><input disabled type="checkbox"> </li>
</ul>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>降级是什么？？</p>
<p>分布式锁的原理？？</p>
<h2 id="第二周"><a href="#第二周" class="headerlink" title="第二周"></a>第二周</h2><h3 id><a href="#" class="headerlink" title></a></h3><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240311102818874.png" srcset="/img/loading.gif" lazyload alt="image-20240311102818874"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240311113903356.png" srcset="/img/loading.gif" lazyload alt="image-20240311113903356"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240311140640873.png" srcset="/img/loading.gif" lazyload alt="image-20240311140640873"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240311155855593.png" srcset="/img/loading.gif" lazyload alt="image-20240311155855593"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240311144112007.png" srcset="/img/loading.gif" lazyload alt="image-20240311144112007"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240311160257935.png" srcset="/img/loading.gif" lazyload alt="image-20240311160257935"></p>
<ul>
<li>本地日志转 udp日志</li>
<li>参与框架的 入参返回值的日志的构建</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> req types.EditDomainCenterRuleTypeReq<br>		<span class="hljs-keyword">var</span> dup io.ReadCloser<br>		r.Body, dup = iox.DupReadCloser(r.Body)<br><br>		<span class="hljs-keyword">if</span> err := httpx.Parse(r, &amp;req); err != <span class="hljs-literal">nil</span> &#123;<br>			r.Body = dup<br>			apiReturn.OkJson(w, r, <span class="hljs-literal">nil</span>, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br><br>		l := logic.NewEditDomainCenterRuleTypeLogic(r.Context(), svcCtx)<br>		resp, err := l.EditDomainCenterRuleType(&amp;req)<br>		r.Body = dup<br>		apiReturn.OkJson(w, r, resp, err)<br></code></pre></td></tr></table></figure>





<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> apiReturn<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;domain_center/common/errorx&quot;</span><br>	<span class="hljs-string">&quot;domain_center/common/yxLog&quot;</span><br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/zeromicro/go-zero/rest/httpx&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	中文乱码问题</span><br><span class="hljs-comment">	resp的解析问题 OK</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">OkJson</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request, resp <span class="hljs-keyword">interface</span>&#123;&#125;, err <span class="hljs-type">error</span>)</span></span> &#123;<br>	<span class="hljs-comment">// 读取请求主体的内容</span><br>	bodyData, _ := ioutil.ReadAll(r.Body)<br><br>	<span class="hljs-comment">// 解析表单数据</span><br>	formData := r.Form.Encode()<br><br>	<span class="hljs-comment">// 构造日志结构体</span><br>	apiLog := <span class="hljs-keyword">struct</span> &#123;<br>		RequestUrl        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_url&quot;`</span><br>		RequestBodyParams <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_body_params&quot;`</span><br>		RequestFormParams <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_form_params&quot;`</span><br>		Response          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;response&quot;`</span><br>	&#125;&#123;<br>		RequestUrl:        r.RequestURI,<br>		RequestBodyParams: <span class="hljs-type">string</span>(bodyData),<br>		RequestFormParams: formData,<br>		Response:          fmt.Sprintf(<span class="hljs-string">&quot;%+v&quot;</span>, resp),<br>	&#125;<br><br>	<span class="hljs-comment">// 打印日志结构体</span><br>	fmt.Println(<span class="hljs-string">&quot;-&gt;&gt;&gt;&quot;</span>, apiLog)<br><br>	<span class="hljs-comment">// 将日志结构体转换为JSON字符串并记录日志</span><br>	logData, err := json.Marshal(apiLog)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-comment">// 处理JSON转换错误</span><br>		http.Error(w, <span class="hljs-string">&quot;Failed to marshal log data&quot;</span>, http.StatusInternalServerError)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	yxLog.Infof(<span class="hljs-string">&quot;%+v&quot;</span>, <span class="hljs-type">string</span>(logData))<br><br>	<span class="hljs-comment">// 返回响应</span><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		httpx.OkJson(w, errorx.NewErrorResponse(err))<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		httpx.OkJson(w, errorx.NewSuccess(resp))<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>









<h4 id="git-提交"><a href="#git-提交" class="headerlink" title="git 提交"></a>git 提交</h4><p>git status</p>
<p>git add .</p>
<p>git commit -m “”</p>
<p>git push</p>
<p>git 提交前</p>
<p>git checkout 分支名字</p>
<p>git reset –hard HEAD</p>
<p>git pull</p>
<p>实时查看日志文件</p>
<p>tail -f fileNmae</p>
<h4 id="redis启动"><a href="#redis启动" class="headerlink" title="redis启动"></a>redis启动</h4><p>docker pull redis	</p>
<p>docker run -d -p 6379:6379 –name my_redis redis</p>
<p>docker start my_redis</p>
<p>docker ps</p>
<p>docker run -p 6379:6379 –name my_redis_v1 -v &#x2F;docker&#x2F;data&#x2F;redis_v1:&#x2F;data redis</p>
<p>docker exec -it my_redis redis_cli</p>
<p>docker exec -it my_redis &#x2F;bin&#x2F;bash</p>
<p><strong>踩坑</strong>： redis的数据没有写入磁盘，使用 SAVE或者是BGSAVE</p>
<h4 id="yx-superviser"><a href="#yx-superviser" class="headerlink" title="yx_superviser"></a>yx_superviser</h4><p>调用 脚手架中的日志框架（udp_host,udp_port,sereviceName）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//读取到的数据为 乱码，我用GBK解码后再读取数据，成功了</span><br>	reader := simplifiedchinese.GBK.NewDecoder().Reader(r.Body)<br>	body, _ := ioutil.ReadAll(reader)<br>	<span class="hljs-comment">//去除req中的换行符号 空格 斜线</span><br>	bodyStr := <span class="hljs-type">string</span>(body)<br>	bodyStr = strings.ReplaceAll(bodyStr, <span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>	<span class="hljs-comment">//bodyStr = strings.ReplaceAll(bodyStr, &quot;\&quot;&quot;, &quot;&quot;)</span><br>	<span class="hljs-comment">//bodyStr = strings.ReplaceAll(bodyStr, &quot; &quot;, &quot;&quot;)</span><br>	<span class="hljs-comment">// 解析表单数据</span><br>	formData := r.Form.Encode()<br><br>	<span class="hljs-comment">// 构造日志结构体</span><br>	apiLog := <span class="hljs-keyword">struct</span> &#123;<br>		RequestUrl        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_url&quot;`</span><br>		RequestBodyParams <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_body_params&quot;`</span><br>		RequestFormParams <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_form_params&quot;`</span><br>		Response          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;response&quot;`</span><br>	&#125;&#123;<br>		RequestUrl:        r.RequestURI,<br>		RequestBodyParams: fmt.Sprintf(<span class="hljs-string">&quot;%s&quot;</span>, bodyStr),<br>		RequestFormParams: formData,<br>		Response:          fmt.Sprintf(<span class="hljs-string">&quot;%v&quot;</span>, resp),<br>	&#125;<br><br>	yxLog.Infof(<span class="hljs-string">&quot;%+v&quot;</span>, apiLog)<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		httpx.OkJson(w, errorx.NewErrorResponse(err))<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		httpx.OkJson(w, errorx.NewSuccess(resp))<br>	&#125;<br></code></pre></td></tr></table></figure>











<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> bigdataLog<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/zeromicro/go-zero/core/logx&quot;</span><br>	<span class="hljs-string">&quot;net&quot;</span><br>	<span class="hljs-string">&quot;runtime&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>	<span class="hljs-string">&quot;yx_supervise_stat/common/utils&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>	levelDebug = <span class="hljs-string">&quot;debug&quot;</span><br>	levelInfo  = <span class="hljs-string">&quot;info&quot;</span><br>	levelWarn  = <span class="hljs-string">&quot;warn&quot;</span><br>	levelError = <span class="hljs-string">&quot;error&quot;</span><br>)<br><br><span class="hljs-comment">// BDLog 大数据日志</span><br><span class="hljs-keyword">type</span> bigDataLog <span class="hljs-keyword">struct</span> &#123;<br>	Client      net.Conn<br>	ServiceName <span class="hljs-type">string</span><br>	IP          <span class="hljs-type">string</span> <span class="hljs-comment">//请求客户端的IP地址</span><br>	Host        <span class="hljs-type">string</span> <span class="hljs-comment">// 日志服务器的IP地址</span><br>	Port        <span class="hljs-type">string</span> <span class="hljs-comment">// 日志服务器的端口</span><br>&#125;<br><br><span class="hljs-keyword">var</span> BDLog *bigDataLog<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBDLog</span><span class="hljs-params">(host, port, serviceName <span class="hljs-type">string</span>)</span></span> &#123;<br>	BDLog = &amp;bigDataLog&#123;<br>		ServiceName: serviceName,<br>		IP:          utils.GetIpAddr(),<br>		Host:        host,<br>		Port:        port,<br>	&#125;<br>	connStr := host + <span class="hljs-string">&quot;:&quot;</span> + port<br>	conn, err := net.Dial(<span class="hljs-string">&quot;udp&quot;</span>, connStr)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;net.Dial error:&quot;</span> + err.Error())<br>	&#125;<br>	BDLog.Client = conn<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *bigDataLog)</span></span> Debugf(message <span class="hljs-type">string</span>, v ...<span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>	b.writeMsg(levelDebug, message, v...)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *bigDataLog)</span></span> Infof(message <span class="hljs-type">string</span>, v ...<span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>	b.writeMsg(levelInfo, message, v...)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *bigDataLog)</span></span> Warnf(message <span class="hljs-type">string</span>, v ...<span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>	b.writeMsg(levelWarn, message, v...)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *bigDataLog)</span></span> Errorf(message <span class="hljs-type">string</span>, v ...<span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>	b.writeMsg(levelError, mes<br>               sage, v...)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *bigDataLog)</span></span> writeMsg(level <span class="hljs-type">string</span>, msg <span class="hljs-type">string</span>, v ...<span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>			b.Client = <span class="hljs-literal">nil</span><br>			fmt.Printf(<span class="hljs-string">&quot;bigData Recovered err:%+v&quot;</span>, err)<br>			logx.Errorf(<span class="hljs-string">&quot;unable to send bigDataLog ,error:%s\n&quot;</span>, err)<br>		&#125;<br>	&#125;()<br><br>	<span class="hljs-comment">//模拟log的规范格式</span><br>	_, file, line, _ := runtime.Caller(<span class="hljs-number">2</span>)<br>	strlog := fmt.Sprintf(<span class="hljs-string">&quot;## %s ## %s ## %s ## %s ## action ## %s ## %s:%d&quot;</span>,<br>		time.Now().Format(utils.TimeLayout),<br>		b.IP,<br>		level,<br>		b.ServiceName,<br>		msg,<br>		file,<br>		line)<br>	fmt.Println(<span class="hljs-string">&quot;bigData---&gt;&quot;</span> + strlog)<br>	<span class="hljs-keyword">if</span> b.Client == <span class="hljs-literal">nil</span> &#123;<br>		NewBDLog(b.Host, b.Port, b.ServiceName)<br>	&#125;<br><br>	_, err := b.Client.Write([]<span class="hljs-type">byte</span>(strlog))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-comment">//超时失败重连</span><br>		NewBDLog(b.Host, b.Port, b.ServiceName)<br>		fmt.Println(err, <span class="hljs-string">&quot;bigData-----failed-----&quot;</span>)<br>	&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">#udp log配置 --业务日志<br>UDP_HOST_BUSINESS = udp.dev.myyixue.com<br>UDP_PORT_BUSINESS = <span class="hljs-number">60135</span><br><br>#udp log配置 --大数据日志<br>UDP_HOST_BIGDATA = udp.dev.myyixue.com<br>UDP_PORT_BIGDATA = <span class="hljs-number">59968</span><br></code></pre></td></tr></table></figure>





<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-comment">//业务日志配置</span><br>UDP_HOST_BUSINESS := os.Getenv(<span class="hljs-string">&quot;UDP_HOST_BUSINESS&quot;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(UDP_HOST_BUSINESS) == <span class="hljs-number">0</span> &#123;<br>	<span class="hljs-built_in">panic</span>(errors.New(<span class="hljs-string">&quot;can not find &#x27;UDP_HOST_BUSINESS&#x27; in config file&quot;</span>))<br>&#125;<br>UDP_PORT_BUSINESS := os.Getenv(<span class="hljs-string">&quot;UDP_PORT_BUSINESS&quot;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(UDP_PORT_BUSINESS) == <span class="hljs-number">0</span> &#123;<br>	<span class="hljs-built_in">panic</span>(errors.New(<span class="hljs-string">&quot;can not find &#x27;UDP_PORT_BUSINESS&#x27; in config file&quot;</span>))<br>&#125;<br><br><span class="hljs-comment">//初始化udp的log传输</span><br>host := UDP_HOST_BUSINESS + <span class="hljs-string">&quot;:&quot;</span> + UDP_PORT_BUSINESS<br>fmt.Println(<span class="hljs-string">&quot;host-&gt;&quot;</span>, host)<br>udpLog := yxLog.NewClient(host, <span class="hljs-string">&quot;yx_supervise_stat&quot;</span>)<br><span class="hljs-comment">//udpLog.Close()</span><br>fmt.Printf(<span class="hljs-string">&quot;udpLog-&gt;%v\n&quot;</span>, udpLog)<br><span class="hljs-comment">//defer udpLog.Close()</span><br>writer := logx.NewWriter(udpLog)<br>logx.SetWriter(writer)<br>yxLog.Infof(<span class="hljs-string">&quot;load config file:%s finish&quot;</span>, *common.ConfigFile)<br><br>yxLog.Infof(<span class="hljs-string">&quot;PID:%d&quot;</span>, os.Getpid())   <span class="hljs-comment">// PID</span><br>yxLog.Infof(<span class="hljs-string">&quot;PPID:%d&quot;</span>, os.Getppid()) <span class="hljs-comment">// PPID</span><br>yxLog.Infof(<span class="hljs-string">&quot;GID:%d&quot;</span>, os.Getgid())   <span class="hljs-comment">// GID</span><br><br></code></pre></td></tr></table></figure>





<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#华为udp log配置 --业务日志</span><br><span class="hljs-attr">UDP_HOST_BUSINESS</span> = udp.dev.myyixue.com<br><span class="hljs-attr">UDP_PORT_BUSINESS</span> = <span class="hljs-number">60135</span><br><br><span class="hljs-comment">#华为udp log配置 --大数据日志</span><br><span class="hljs-attr">UDP_HOST_HW</span> = udp.dev.myyixue.com<br><span class="hljs-attr">UDP_PORT_HW</span> = <span class="hljs-number">59968</span><br></code></pre></td></tr></table></figure>



<h4 id="domain-center"><a href="#domain-center" class="headerlink" title="domain_center"></a>domain_center</h4><h4 id="decode-和encode的区别"><a href="#decode-和encode的区别" class="headerlink" title="decode 和encode的区别"></a>decode 和encode的区别</h4><p>decode 是解码</p>
<h4 id="乱码问题"><a href="#乱码问题" class="headerlink" title="乱码问题"></a>乱码问题</h4><p><a target="_blank" rel="noopener" href="https://www.codeprj.com/blog/ba98331.html">再次遇到golang乱码问题，用simplifiedchinese解决 - 码上快乐 (codeprj.com)</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGBK2UTF8</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-keyword">var</span> r *http.Request<br>    <span class="hljs-comment">//decoder是解码</span><br>	reader := simplifiedchinese.GBK.NewDecoder().Reader(r.Body)<br><br>	body, _ := ioutil.ReadAll(reader)<br>	fmt.Println(<span class="hljs-type">string</span>(body))<br>&#125;<br><br></code></pre></td></tr></table></figure>





<h4 id="io-Reader的重复读问题"><a href="#io-Reader的重复读问题" class="headerlink" title="io.Reader的重复读问题"></a>io.Reader的重复读问题</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DupReadCloser</span><span class="hljs-params">(reader io.ReadCloser)</span></span> (io.ReadCloser, io.ReadCloser) &#123;<br>   <span class="hljs-keyword">var</span> buf bytes.Buffer<br>   tee := io.TeeReader(reader, &amp;buf)<br>   <span class="hljs-keyword">return</span> io.NopCloser(tee), io.NopCloser(&amp;buf)<br>&#125;<br></code></pre></td></tr></table></figure>





<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> dup io.ReadCloser<br>r.Body, dup = iox.DupReadCloser(r.Body)<br><br><span class="hljs-keyword">if</span> err := httpx.Parse(r, &amp;req); err != <span class="hljs-literal">nil</span> &#123;<br>	r.Body = dup<br>	apiReturn.OkJson(w, r, <span class="hljs-literal">nil</span>, err)<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br>l := logic.NewCreateDomainCenterRuleLogic(r.Context(), svcCtx)<br>resp, err := l.CreateDomainCenterRule(&amp;req)<br>r.Body = dup<br>apiReturn.OkJson(w, r, resp, err)<br></code></pre></td></tr></table></figure>



<h4 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h4><ul>
<li><p>docker pull mysql</p>
</li>
<li><p>$ docker run -itd –name my_mysql_v1 -v mysql_v1 -p 3306:3306 -e MYSQL_ROOT_PASSWORD&#x3D;123456 mysql</p>
</li>
<li><p>docker exec -it my_mysql  &#x2F;bin&#x2F;bash</p>
</li>
<li><p>mysql -h localhost -u root -p</p>
</li>
<li><p>其中密码是 123456</p>
</li>
</ul>
<h4 id="grpc"><a href="#grpc" class="headerlink" title="grpc"></a>grpc</h4><p>验证 protoc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">protoc --version<br></code></pre></td></tr></table></figure>

<p>验证protoc-gen-go</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">protoc-gen-go --version<br></code></pre></td></tr></table></figure>

<p>验证protoc-gen-go-grpc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">protoc-gen-go-grpc --version <br></code></pre></td></tr></table></figure>





<p>创建protoc文件</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs protobuf">syntax= <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-keyword">option</span> go_package=<span class="hljs-string">&quot;client/pb&quot;</span>;<br><br><span class="hljs-keyword">package</span> pb;<br><br><span class="hljs-keyword">service </span><span class="hljs-title class_">Greeter</span> &#123;<br>  <span class="hljs-function"><span class="hljs-keyword">rpc</span> SayHello(HelloRequest)<span class="hljs-keyword">returns</span>(HelloResponse)</span>;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">HelloRequest</span> &#123;<br>  <span class="hljs-type">string</span> name = <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-keyword">message </span><span class="hljs-title class_">HelloResponse</span>&#123;<br>  <span class="hljs-type">string</span> reply =<span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>生成pb文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">protoc --go_out=. --go_opt=paths=source_relative \<br>--go-grpc_out=. --go-grpc_opt=paths=source_relative \<br>pb/hello.proto<br></code></pre></td></tr></table></figure>



<p>错误处理</p>
<h4 id="UDP-端口号申请"><a href="#UDP-端口号申请" class="headerlink" title="UDP 端口号申请"></a>UDP 端口号申请</h4><p>Hi，王哥：</p>
<p> yx_supervise_stat项目，主要功能是 监控用户的在线行为 ，因需要本地日志打UDP日志，</p>
<p>工作负载prod-basic-be-yxsupervisestat ，申请 udp <strong>业务日志</strong>，高峰每小时大约 写入 150000 行，数据量约90M。</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240314103447772.png" srcset="/img/loading.gif" lazyload alt="image-20240314103447772"></p>
<h4 id="提测"><a href="#提测" class="headerlink" title="提测"></a>提测</h4><h4 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h4><p>rabbitMQ环境搭建</p>
<p>rabbitMQ-example</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-tutorials/tree/main/go">rabbitmq-tutorials&#x2F;go at main · rabbitmq&#x2F;rabbitmq-tutorials (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-go">RabbitMQ tutorial - “Hello World!” | RabbitMQ</a></p>
<h5 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h5><ul>
<li><p>docker pull rabbitmq</p>
</li>
<li><p>docker run -d –name my_rabbitmq -p 15672:15672 rabbitmq</p>
</li>
<li><p>docker exec -it {container_name||container_id} &#x2F;bin&#x2F;bash</p>
</li>
<li><p>rabbitmq-plugins enable rabbitmq_management </p>
</li>
<li><p>打开 127.0.0.1:15672 其中账号密码都是 guest</p>
</li>
</ul>
<h4 id="邮件抄送加组"><a href="#邮件抄送加组" class="headerlink" title="邮件抄送加组"></a>邮件抄送加组</h4><h4 id="开发环境运行"><a href="#开发环境运行" class="headerlink" title="开发环境运行"></a>开发环境运行</h4><p><a target="_blank" rel="noopener" href="http://wiki.classba.com.cn/pages/viewpage.action?pageId=64423134">开发环境部署 - 智能硬件后端 - Confluence (classba.com.cn)</a></p>
<ol>
<li>连接 开发环境的机器</li>
<li>进入 &#x2F;home&#x2F;yansiatao 的目录</li>
<li>git clone 代码</li>
<li>git checkout 到自己的代码位置</li>
<li>cp nginx模版文件到&#x2F;home&#x2F;basic&#x2F;nginx下，并将配置文件改为自己的项目名称</li>
<li>修改nginx的转发配置；使用 nginx -t 检测；使用 Nginx -s reload </li>
<li>编译运行go项目</li>
</ol>
<p>Nginx conf的配置</p>
<h4 id="提测-1"><a href="#提测-1" class="headerlink" title="提测"></a>提测</h4><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240314185559915.png" srcset="/img/loading.gif" lazyload alt="image-20240314185559915"></p>
<ul>
<li>需求文档寻找</li>
<li>写tapd文档</li>
</ul>
<h4 id="键盘关机"><a href="#键盘关机" class="headerlink" title="键盘关机"></a>键盘关机</h4><p>sc config i8042prt start&#x3D; disabled</p>
<h4 id="短信业务"><a href="#短信业务" class="headerlink" title="短信业务"></a>短信业务</h4><p>自定义的func，且http调用用不到的，用小写开头</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">copier.<span class="hljs-constructor">Copy(&amp;<span class="hljs-params">pbHomestayOrder</span>, <span class="hljs-params">homestayOrder</span>)</span><br></code></pre></td></tr></table></figure>

<h5 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">//========================&gt; 系统类型 &lt;========================<br><br>@doc <span class="hljs-string">&quot;保存系统类型&quot;</span><br>@handler systemConfigSave<br>post /systemConfig/save (SystemConfigSaveReq) returns (SystemConfigInfoResp)<br><br>@doc <span class="hljs-string">&quot;系统类型详情&quot;</span><br>@handler systemConfigInfo<br>post /systemConfig/info (SystemConfigInfoReq) returns (SystemConfigInfoResp)<br><br>@doc <span class="hljs-string">&quot;系统类型列表&quot;</span><br>@handler systemConfigList<br>post /systemConfig/list (SystemConfigListReq) returns (SystemConfigListResp)<br><br>//========================&gt; 短信类型 &lt;========================<br><br>@doc <span class="hljs-string">&quot;保存短信类型&quot;</span><br>@handler smsConfigSave<br>post /smsConfig/save (SmsConfigSaveReq) returns (SmsConfigInfoResp)<br><br>@doc <span class="hljs-string">&quot;短信类型详情&quot;</span><br>@handler smsConfigInfo<br>post /smsConfig/info (SmsConfigInfoReq) returns (SmsConfigInfoResp)<br><br>@doc <span class="hljs-string">&quot;短信类型列表&quot;</span><br>@handler smsConfigList<br>post /smsConfig/list (SmsConfigListReq) returns (SmsConfigListResp)<br><br>//========================&gt; 短信模板 &lt;========================<br><br>@doc <span class="hljs-string">&quot;保存短信模板&quot;</span><br>@handler smsTemplateConfigSave<br>post /smsTemplateConfig/save (SmsTemplateConfigSaveReq) returns (SmsTemplateConfigInfoResp)<br><br>@doc <span class="hljs-string">&quot;短信模板详情&quot;</span><br>@handler smsTemplateConfigInfo<br>post /smsTemplateConfig/info (SmsTemplateConfigInfoReq) returns (SmsTemplateConfigInfoResp)<br><br>@doc <span class="hljs-string">&quot;短信模板列表&quot;</span><br>@handler smsTemplateConfigList<br>post /smsTemplateConfig/list (SmsTemplateConfigListReq) returns (SmsTemplateConfigListResp)<br></code></pre></td></tr></table></figure>









<h5 id="完成的接口"><a href="#完成的接口" class="headerlink" title="完成的接口"></a>完成的接口</h5><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240316145128673.png" srcset="/img/loading.gif" lazyload alt="image-20240316145128673"></p>
<p>考虑缓存</p>
<p>思考表的结构</p>
<p>表的设计规范&amp;&amp;原则</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240316192133547.png" srcset="/img/loading.gif" lazyload alt="image-20240316192133547"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240316201236366.png" srcset="/img/loading.gif" lazyload alt="image-20240316201236366"></p>
<h2 id="第三周"><a href="#第三周" class="headerlink" title="第三周"></a>第三周</h2><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240318151103611.png" srcset="/img/loading.gif" lazyload alt="image-20240318151103611"></p>
<h4 id="坑："><a href="#坑：" class="headerlink" title="坑："></a>坑：</h4><p>以为 表中有 create_at时自动更改字段。。</p>
<p>更改字段没有传ID</p>
<p>没有充分利用已有的format</p>
<p>status</p>
<h5 id="未完成"><a href="#未完成" class="headerlink" title="未完成"></a>未完成</h5><p><strong>日志处理</strong></p>
<p><strong>添加redis缓存</strong></p>
<p>save</p>
<h5 id="git"><a href="#git" class="headerlink" title="git"></a>git</h5><p>git stash  将本地修改暂存</p>
<p>git pull </p>
<p>git stash pop 将本地暂存pop出来</p>
<p>git add .</p>
<p>git commit -m “msg”</p>
<p>git reset</p>
<p>git log</p>
<p>yx_supervise_stat 错误处理</p>
<p>struct没有json对应，最终结果为默认值，缓存结果出错</p>
<p>传入redis中string的value范围没包括ID，导致最终update失败</p>
<p>cron</p>
<p>yxmsg:SystemConfig:test_26</p>
<p>yxmsg:SmsTemplateConfigNew:test_28:test_24</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">TSmsTemplateConfig struct &#123;<br>   Id           int64     `db:<span class="hljs-string">&quot;id&quot;</span> json:<span class="hljs-string">&quot;id&quot;</span>`            <span class="hljs-regexp">//</span> 自增ID<br>   SystemType   string    `db:<span class="hljs-string">&quot;system_type&quot;</span> json:<span class="hljs-string">&quot;system_type&quot;</span>`   <span class="hljs-regexp">//</span> 系统类型<br>   SystemId     int64     `db:<span class="hljs-string">&quot;system_id&quot;</span> json:<span class="hljs-string">&quot;system_id&quot;</span>`     <span class="hljs-regexp">//</span> 系统ID<br>   Category     int64     `db:<span class="hljs-string">&quot;category&quot;</span> json:<span class="hljs-string">&quot;category&quot;</span>`      <span class="hljs-regexp">//</span> 分类，<span class="hljs-number">1</span>为验证码，<span class="hljs-number">2</span>为通知类<br>   SmsType      string    `db:<span class="hljs-string">&quot;sms_type&quot;</span> json:<span class="hljs-string">&quot;sms_type&quot;</span>`      <span class="hljs-regexp">//</span> 短信类型<br>   SmsId        int64     `db:<span class="hljs-string">&quot;sms_id&quot;</span> json:<span class="hljs-string">&quot;sms_id&quot;</span>`        <span class="hljs-regexp">//</span> 短信ID<br>   TemplateId   string    `db:<span class="hljs-string">&quot;template_id&quot;</span> json:<span class="hljs-string">&quot;template_id&quot;</span>`   <span class="hljs-regexp">//</span> 模板ID<br>   TemplateSign string    `db:<span class="hljs-string">&quot;template_sign&quot;</span> json:<span class="hljs-string">&quot;template_sign&quot;</span>` <span class="hljs-regexp">//</span> 模板签名<br>   TemplateMsg  string    `db:<span class="hljs-string">&quot;template_msg&quot;</span> json:<span class="hljs-string">&quot;template_msg&quot;</span>`  <span class="hljs-regexp">//</span> 模板内容<br>   Required     string    `db:<span class="hljs-string">&quot;required&quot;</span> json:<span class="hljs-string">&quot;required&quot;</span>`      <span class="hljs-regexp">//</span> 必要参数<br>   CreateUser   int64     `db:<span class="hljs-string">&quot;create_user&quot;</span> json:<span class="hljs-string">&quot;create_user&quot;</span>`   <span class="hljs-regexp">//</span> 创建人<br>   UpdateUser   int64     `db:<span class="hljs-string">&quot;update_user&quot;</span> json:<span class="hljs-string">&quot;update_user&quot;</span>`   <span class="hljs-regexp">//</span> 更新人<br>   Created      time.Time `db:<span class="hljs-string">&quot;created&quot;</span> json:<span class="hljs-string">&quot;created&quot;</span>`       <span class="hljs-regexp">//</span> 创建时间<br>   Updated      time.Time `db:<span class="hljs-string">&quot;updated&quot;</span> json:<span class="hljs-string">&quot;updated&quot;</span>`       <span class="hljs-regexp">//</span> 更新时间<br>   Status       int64     `db:<span class="hljs-string">&quot;status&quot;</span> json:<span class="hljs-string">&quot;status&quot;</span>`        <span class="hljs-regexp">//</span> 状态 <span class="hljs-number">1</span>：使用(默认) <span class="hljs-number">0</span>：停用<br>   IsDel        int64     `db:<span class="hljs-string">&quot;is_del&quot;</span> json:<span class="hljs-string">&quot;is_del&quot;</span>`         <span class="hljs-regexp">//</span> 删除状态 <span class="hljs-number">0</span>：正常(默认) <span class="hljs-number">1</span>：删除<br>&#125;<br></code></pre></td></tr></table></figure>





<p>坑：</p>
<p>​	</p>
<h4 id="单元测试："><a href="#单元测试：" class="headerlink" title="单元测试："></a>单元测试：</h4><p>​	抽离公共部分</p>
<p>​	写req，resp</p>
<p>​	Smstempalate，SystemConfig，Smstemplate</p>
<h4 id="文档编写"><a href="#文档编写" class="headerlink" title="文档编写"></a>文档编写</h4><p>done</p>
<p>良好的rpc调用是面向服务的封装，针对服务的可用性和效率都做了优化。单程使用http调用则缺少了这种特性。</p>
<p>setbit key offset value</p>
<p>getbit key offset</p>
<p>gitcount key </p>
<p>bitpos key 0|1</p>
<p>七天产生一个</p>
<p>bylex</p>
<p>rangebyscore</p>
<p>range </p>
<p>revRange</p>
<p>zadd</p>
<p>zrem</p>
<p>zcard</p>
<p>zrange</p>
<p>zrangeBylex</p>
<p>zrangeByscore</p>
<p>zincBy</p>
<p>Zscore</p>
<p>周报：</p>
<p>完成上线</p>
<p>接口编写</p>
<p>单元测试</p>
<p>文档编写</p>
<h4 id="查询某个表的总行数"><a href="#查询某个表的总行数" class="headerlink" title="查询某个表的总行数"></a>查询某个表的总行数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT <br>    TABLE_NAME AS 表名,<br>    TABLE_ROWS AS 行数<br>FROM <br>    information_schema.TABLES <br>WHERE <br>    TABLE_SCHEMA = &#x27;yx_user_message&#x27;<br>AND<br>    TABLE_NAME LIKE &#x27;t_user_message_%&#x27;;<br></code></pre></td></tr></table></figure>





<p>分表查询</p>
<p>开携程查询</p>
<p>先统计数据</p>
<p>小部分实验</p>
<p>pull_time不用查询</p>
<p>user_message</p>
<p>t_user_message_read 的每张表是对应的</p>
<p>查询时间占比小</p>
<p>插入占比大</p>
<p>连接字符串要</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM `t_user_message_0`<br><br><br>SELECT <br>    account_id, <br>    SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) AS unread_count,<br>    MAX(IF(status = 1, updated, NULL)) AS pull_time<br>FROM <br>    t_user_message_0<br>GROUP BY <br>    account_id;<br><br>## accoutID 取md5值，最终存入md5[0:1]对应的表中<br>select *<br>from t_user_message_0<br>WHERE account_id=3102526131924236;<br></code></pre></td></tr></table></figure>





<p>统计：</p>
<p>​	非批量查询</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240321155800311.png" srcset="/img/loading.gif" lazyload alt="image-20240321155800311"></p>
<p>​	批量查询</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240321160134069.png" srcset="/img/loading.gif" lazyload alt="image-20240321160134069"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240321160224013.png" srcset="/img/loading.gif" lazyload alt="image-20240321160224013"></p>
<p>设计一个通用的 数据更新、数据同步的脚本</p>
<p>携程可控 OK</p>
<p>脚本可重复使用（可以更新，插入数据）</p>
<p>分页查询 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;database/sql&quot;</span><br>   <span class="hljs-string">&quot;fmt&quot;</span><br>   _ <span class="hljs-string">&quot;github.com/go-sql-driver/mysql&quot;</span><br>   <span class="hljs-string">&quot;sync&quot;</span><br>   <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> channelSize = <span class="hljs-number">20</span><br><span class="hljs-keyword">const</span> pageSize = <span class="hljs-number">50</span><br><br><span class="hljs-keyword">var</span> ch = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, channelSize)<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">syncTable</span><span class="hljs-params">(db *sql.DB, tableName <span class="hljs-type">string</span>)</span></span> &#123;<br>   <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>      &lt;-ch<br>      wg.Done()<br>   &#125;()<br><br>   <span class="hljs-comment">// 查询每个表中每个用户的未读消息数</span><br>   <span class="hljs-comment">// select account_id, count(1) as unread_count from t_user_message_0 where status = 0 ;</span><br>   rows, err := db.Query(fmt.Sprintf(<span class="hljs-string">&quot;SELECT account_id, count(1) AS unread_count FROM %s WHERE status = 0 &quot;</span>, tableName))<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      fmt.Println(<span class="hljs-string">&quot;Error querying table&quot;</span>, tableName, <span class="hljs-string">&quot;:&quot;</span>, err.Error())<br>      <span class="hljs-built_in">panic</span>(err.Error())<br>   &#125;<br>   <span class="hljs-keyword">defer</span> rows.Close()<br><br>   <span class="hljs-comment">// 构建对应的 t_user_message_read 表名</span><br>   readTableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_read_%s&quot;</span>, tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):])<br>   fmt.Println(<span class="hljs-string">&quot;readTableName:-&gt;&gt;&gt;&gt;&quot;</span>, readTableName)<br><br>   <span class="hljs-comment">// 准备批量插入的语句</span><br>   execStr := <span class="hljs-string">&quot;INSERT INTO &quot;</span> + readTableName + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>   <span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;<br><br>   <span class="hljs-keyword">var</span> accountID, unreadCount <span class="hljs-type">int</span><br>   count := <span class="hljs-number">0</span><br>   <span class="hljs-comment">// 遍历查询结果，构建批量插入语句的值</span><br>   <span class="hljs-keyword">for</span> rows.Next() &#123;<br>      <span class="hljs-keyword">if</span> err := rows.Scan(&amp;accountID, &amp;unreadCount); err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Println(<span class="hljs-string">&quot;Error scanning row:&quot;</span>, err.Error())<br>         <span class="hljs-built_in">panic</span>(err.Error())<br>      &#125;<br><br>      <span class="hljs-comment">// 添加到批量插入语句的值列表中</span><br>      execStr += <span class="hljs-string">&quot;(?, ?),&quot;</span><br>      values = <span class="hljs-built_in">append</span>(values, accountID, unreadCount)<br>      count++<br><br>      <span class="hljs-comment">// 每达到 50 条记录就执行批量插入</span><br>      <span class="hljs-keyword">if</span> count == <span class="hljs-number">50</span> &#123;<br>         <span class="hljs-comment">// 启动一个 Goroutine 执行批量插入操作</span><br>         wg.Add(<span class="hljs-number">1</span>)<br>         ch &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>         <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>               &lt;-ch<br>               wg.Done()<br>            &#125;()<br><br>            <span class="hljs-comment">// 执行批量插入</span><br>            execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>            _, err := db.Exec(execStr, values...)<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>               fmt.Println(<span class="hljs-string">&quot;Error executing batch insert for table&quot;</span>, readTableName, <span class="hljs-string">&quot;:&quot;</span>, err.Error())<br>               <span class="hljs-built_in">panic</span>(err.Error())<br>            &#125;<br>         &#125;(execStr, values)<br><br>         <span class="hljs-comment">// 清空批量插入语句和值列表</span><br>         execStr = <span class="hljs-string">&quot;INSERT INTO &quot;</span> + readTableName + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>         values = []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>         count = <span class="hljs-number">0</span><br>      &#125;<br>   &#125;<br>   <span class="hljs-comment">//数据同步，数据更新</span><br>   <span class="hljs-comment">// select * from a where limit x,y</span><br>   <span class="hljs-comment">//</span><br><br>   <span class="hljs-comment">// 如果还有剩余的数据没有插入，执行最后一次批量插入</span><br>   <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;<br>      <span class="hljs-comment">// 启动一个 Goroutine 执行批量插入操作</span><br>      wg.Add(<span class="hljs-number">1</span>)<br>      ch &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>      <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>         <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            &lt;-ch<br>            wg.Done()<br>         &#125;()<br><br>         <span class="hljs-comment">// 执行批量插入</span><br>         execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>         _, err := db.Exec(execStr, values...)<br>         <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;Error executing batch insert for table&quot;</span>, readTableName, <span class="hljs-string">&quot;:&quot;</span>, err.Error())<br>            <span class="hljs-built_in">panic</span>(err.Error())<br>         &#125;<br>      &#125;(execStr, values)<br>   &#125;<br><br>   <span class="hljs-keyword">if</span> err := rows.Err(); err != <span class="hljs-literal">nil</span> &#123;<br>      fmt.Println(<span class="hljs-string">&quot;Error iterating over rows:&quot;</span>, err.Error())<br>      <span class="hljs-built_in">panic</span>(err.Error())<br>   &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>   now := time.Now()<br>   <span class="hljs-comment">// 连接数据库</span><br>   db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;db_admin:dWjJdtCJH11JHinAn8$@tcp(songshutest.internal.cn-east-3.mysql.rds.myhuaweicloud.com:3306)/yx_user_message?charset=utf8mb4&amp;parseTime=true&amp;loc=Asia%2FShanghai&quot;</span>)<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      fmt.Println(<span class="hljs-string">&quot;Error connecting to database:&quot;</span>, err.Error())<br>      <span class="hljs-built_in">panic</span>(err.Error())<br>   &#125;<br>   <span class="hljs-keyword">defer</span> db.Close()<br><br>   <span class="hljs-comment">// 并发处理每个分表的数据同步</span><br>   <span class="hljs-keyword">for</span> tableSuffix := <span class="hljs-number">0</span>; tableSuffix &lt; <span class="hljs-number">16</span>; tableSuffix++ &#123;<br>      tableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_%x&quot;</span>, tableSuffix) <span class="hljs-comment">// 根据后缀生成表名</span><br>      wg.Add(<span class="hljs-number">1</span>)<br>      ch &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>      <span class="hljs-keyword">go</span> syncTable(db, tableName)<br>   &#125;<br><br>   <span class="hljs-comment">// 等待所有 Goroutines 完成</span><br>   wg.Wait()<br><br>   fmt.Println(<span class="hljs-string">&quot;Data synchronization completed succes6fully.&quot;</span>)<br>   fmt.Println(<span class="hljs-string">&quot;Time taken:&quot;</span>, time.Since(now))<br>&#125;<br></code></pre></td></tr></table></figure>









<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">syncTable</span><span class="hljs-params">(db *sql.DB, tableName <span class="hljs-type">string</span>, wg *sync.WaitGroup)</span></span> &#123;<br>	<span class="hljs-keyword">defer</span> wg.Done()<br><br>	<span class="hljs-comment">// 查询每个表中每个用户的未读消息数</span><br>	<span class="hljs-comment">// select account_id, count(1) as unread_count from t_user_message_0 where status = 0 group by account_id;</span><br>	rows, err := db.Query(fmt.Sprintf(<span class="hljs-string">&quot;SELECT account_id, count(1) AS unread_count FROM %s WHERE status = 0 GROUP BY account_id&quot;</span>, tableName))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;Error querying table&quot;</span>, tableName, <span class="hljs-string">&quot;:&quot;</span>, err.Error())<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br>	<span class="hljs-keyword">defer</span> rows.Close()<br><br>	<span class="hljs-comment">// 构建对应的 t_user_message_read 表名</span><br>	readTableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_read_%s&quot;</span>, tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):])<br>	fmt.Println(<span class="hljs-string">&quot;readTableName:-&gt;&gt;&gt;&gt;&quot;</span>, readTableName)<br><br>	<span class="hljs-comment">// 准备批量插入的语句</span><br>	execStr := <span class="hljs-string">&quot;INSERT INTO &quot;</span> + readTableName + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>	<span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;<br><br>	<span class="hljs-keyword">var</span> accountID, unreadCount <span class="hljs-type">int</span><br>	count := <span class="hljs-number">0</span><br>	<span class="hljs-comment">// 遍历查询结果，构建批量插入语句的值</span><br>	<span class="hljs-keyword">for</span> rows.Next() &#123;<br>		<span class="hljs-keyword">if</span> err := rows.Scan(&amp;accountID, &amp;unreadCount); err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;Error scanning row:&quot;</span>, err.Error())<br>			<span class="hljs-built_in">panic</span>(err.Error())<br>		&#125;<br><br>		<span class="hljs-comment">// 添加到批量插入语句的值列表中</span><br>		execStr += <span class="hljs-string">&quot;(?, ?),&quot;</span><br>		values = <span class="hljs-built_in">append</span>(values, accountID, unreadCount)<br>		count++<br><br>		<span class="hljs-comment">// 每达到 20 条记录就执行批量插入</span><br>		<span class="hljs-keyword">if</span> count == <span class="hljs-number">20</span> &#123;<br>			<span class="hljs-comment">// 启动一个 Goroutine 执行批量插入操作</span><br>			wg.Add(<span class="hljs-number">1</span>)<br>			<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>				<span class="hljs-keyword">defer</span> wg.Done()<br><br>				<span class="hljs-comment">// 执行批量插入</span><br>				execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>				_, err := db.Exec(execStr, values...)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					fmt.Println(<span class="hljs-string">&quot;Error executing batch insert for table&quot;</span>, readTableName, <span class="hljs-string">&quot;:&quot;</span>, err.Error())<br>					<span class="hljs-built_in">panic</span>(err.Error())<br>				&#125;<br>			&#125;(execStr, values)<br><br>			<span class="hljs-comment">// 清空批量插入语句和值列表</span><br>			execStr = <span class="hljs-string">&quot;INSERT INTO &quot;</span> + readTableName + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>			values = []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>			count = <span class="hljs-number">0</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 如果还有剩余的数据没有插入，执行最后一次批量插入</span><br>	<span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// 启动一个 Goroutine 执行批量插入操作</span><br>		wg.Add(<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> wg.Done()<br><br>			<span class="hljs-comment">// 执行批量插入</span><br>			execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>			_, err := db.Exec(execStr, values...)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Println(<span class="hljs-string">&quot;Error executing batch insert for table&quot;</span>, readTableName, <span class="hljs-string">&quot;:&quot;</span>, err.Error())<br>				<span class="hljs-built_in">panic</span>(err.Error())<br>			&#125;<br>		&#125;(execStr, values)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> err := rows.Err(); err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;Error iterating over rows:&quot;</span>, err.Error())<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	now := time.Now()<br>	<span class="hljs-comment">// 连接数据库</span><br>	db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;db_admin:dWjJdtCJH11JHinAn8$@tcp(songshutest.internal.cn-east-3.mysql.rds.myhuaweicloud.com:3306)/yx_user_message?charset=utf8mb4&amp;parseTime=true&amp;loc=Asia%2FShanghai&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;Error connecting to database:&quot;</span>, err.Error())<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br>	<span class="hljs-keyword">defer</span> db.Close()<br><br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>	<span class="hljs-comment">// 并发处理每个分表的数据同步</span><br>	<span class="hljs-keyword">for</span> tableSuffix := <span class="hljs-number">0</span>; tableSuffix &lt; <span class="hljs-number">1</span>; tableSuffix++ &#123;<br>		tableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_%x&quot;</span>, tableSuffix) <span class="hljs-comment">// 根据后缀生成表名</span><br>		wg.Add(<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">go</span> syncTable(db, tableName, &amp;wg)<br>	&#125;<br><br>	<span class="hljs-comment">// 等待所有 Goroutines 完成</span><br>	wg.Wait()<br><br>	fmt.Println(<span class="hljs-string">&quot;Data synchronization completed successfully.&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;Time taken:&quot;</span>, time.Since(now))<br>&#125;<br><br></code></pre></td></tr></table></figure>







<p>orignial:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;database/sql&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	_ <span class="hljs-string">&quot;github.com/go-sql-driver/mysql&quot;</span><br>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">syncTable</span><span class="hljs-params">(db *sql.DB, tableName <span class="hljs-type">string</span>, wg *sync.WaitGroup)</span></span> &#123;<br>	<span class="hljs-keyword">defer</span> wg.Done()<br><br>	<span class="hljs-comment">// 查询每个表中每个用户的未读消息数</span><br>	<span class="hljs-comment">// select account_id, count(1) as unread_count from t_user_message_0 where status = 0 group by account_id;</span><br>	rows, err := db.Query(fmt.Sprintf(<span class="hljs-string">&quot;SELECT account_id, count(1) AS unread_count FROM %s WHERE status = 0 GROUP BY account_id&quot;</span>, tableName))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;Error querying table&quot;</span>, tableName, <span class="hljs-string">&quot;:&quot;</span>, err.Error())<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br>	<span class="hljs-keyword">defer</span> rows.Close()<br><br>	<span class="hljs-comment">// 构建对应的 t_user_message_read 表名</span><br>	readTableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_read_%s&quot;</span>, tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):])<br>	fmt.Println(<span class="hljs-string">&quot;readTableName:-&gt;&gt;&gt;&gt;&quot;</span>, readTableName)<br><br>	<span class="hljs-comment">// 准备批量插入的语句</span><br>	execStr := <span class="hljs-string">&quot;INSERT INTO &quot;</span> + readTableName + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>	<span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;<br><br>	<span class="hljs-keyword">var</span> accountID, unreadCount <span class="hljs-type">int</span><br>	count := <span class="hljs-number">0</span><br>	<span class="hljs-comment">// 遍历查询结果，构建批量插入语句的值</span><br>	<span class="hljs-keyword">for</span> rows.Next() &#123;<br>		<span class="hljs-keyword">if</span> err := rows.Scan(&amp;accountID, &amp;unreadCount); err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;Error scanning row:&quot;</span>, err.Error())<br>			<span class="hljs-built_in">panic</span>(err.Error())<br>		&#125;<br><br>		<span class="hljs-comment">// 添加到批量插入语句的值列表中</span><br>		execStr += <span class="hljs-string">&quot;(?, ?),&quot;</span><br>		values = <span class="hljs-built_in">append</span>(values, accountID, unreadCount)<br>		count++<br><br>		<span class="hljs-comment">// 每达到 20 条记录就执行批量插入</span><br>		<span class="hljs-keyword">if</span> count == <span class="hljs-number">20</span> &#123;<br>			<span class="hljs-comment">// 启动一个 Goroutine 执行批量插入操作</span><br>			wg.Add(<span class="hljs-number">1</span>)<br>			<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>				<span class="hljs-keyword">defer</span> wg.Done()<br><br>				<span class="hljs-comment">// 执行批量插入</span><br>				execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>				_, err := db.Exec(execStr, values...)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					fmt.Println(<span class="hljs-string">&quot;Error executing batch insert for table&quot;</span>, readTableName, <span class="hljs-string">&quot;:&quot;</span>, err.Error())<br>					<span class="hljs-built_in">panic</span>(err.Error())<br>				&#125;<br>			&#125;(execStr, values)<br><br>			<span class="hljs-comment">// 清空批量插入语句和值列表</span><br>			execStr = <span class="hljs-string">&quot;INSERT INTO &quot;</span> + readTableName + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>			values = []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>			count = <span class="hljs-number">0</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 如果还有剩余的数据没有插入，执行最后一次批量插入</span><br>	<span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// 启动一个 Goroutine 执行批量插入操作</span><br>		wg.Add(<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> wg.Done()<br><br>			<span class="hljs-comment">// 执行批量插入</span><br>			execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>			_, err := db.Exec(execStr, values...)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Println(<span class="hljs-string">&quot;Error executing batch insert for table&quot;</span>, readTableName, <span class="hljs-string">&quot;:&quot;</span>, err.Error())<br>				<span class="hljs-built_in">panic</span>(err.Error())<br>			&#125;<br>		&#125;(execStr, values)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> err := rows.Err(); err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;Error iterating over rows:&quot;</span>, err.Error())<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	now := time.Now()<br>	<span class="hljs-comment">// 连接数据库</span><br>	db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;db_admin:dWjJdtCJH11JHinAn8$@tcp(songshutest.internal.cn-east-3.mysql.rds.myhuaweicloud.com:3306)/yx_user_message?charset=utf8mb4&amp;parseTime=true&amp;loc=Asia%2FShanghai&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;Error connecting to database:&quot;</span>, err.Error())<br>		<span class="hljs-built_in">panic</span>(err.Error())<br>	&#125;<br>	<span class="hljs-keyword">defer</span> db.Close()<br><br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>	<span class="hljs-comment">// 并发处理每个分表的数据同步</span><br>	<span class="hljs-keyword">for</span> tableSuffix := <span class="hljs-number">0</span>; tableSuffix &lt; <span class="hljs-number">1</span>; tableSuffix++ &#123;<br>		tableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_%x&quot;</span>, tableSuffix) <span class="hljs-comment">// 根据后缀生成表名</span><br>		wg.Add(<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">go</span> syncTable(db, tableName, &amp;wg)<br>	&#125;<br><br>	<span class="hljs-comment">// 等待所有 Goroutines 完成</span><br>	wg.Wait()<br><br>	fmt.Println(<span class="hljs-string">&quot;Data synchronization completed successfully.&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;Time taken:&quot;</span>, time.Since(now))<br>&#125;<br><br></code></pre></td></tr></table></figure>





<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240321191903717.png" srcset="/img/loading.gif" lazyload alt="image-20240321191903717"></p>
<h4 id="可以跑通的代码"><a href="#可以跑通的代码" class="headerlink" title="可以跑通的代码"></a>可以跑通的代码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;database/sql&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	_ <span class="hljs-string">&quot;github.com/go-sql-driver/mysql&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>	pageSize       = <span class="hljs-number">2000</span>        <span class="hljs-comment">// 每页查询的记录数</span><br>	concurrency    = <span class="hljs-number">5</span>           <span class="hljs-comment">// 并发携程的数量</span><br>	batchSize      = <span class="hljs-number">2000</span>        <span class="hljs-comment">// 每次批量插入的记录数</span><br>	totalTables    = <span class="hljs-number">16</span>          <span class="hljs-comment">// 分表的总数</span><br>	channelBufSize = concurrency <span class="hljs-comment">// 信号量的缓冲区大小等于并发携程的数量</span><br>)<br><br><span class="hljs-keyword">type</span> Worker <span class="hljs-keyword">struct</span> &#123;<br>	db        *sql.DB<br>	tableName <span class="hljs-type">string</span><br>	semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; <span class="hljs-comment">// 用于控制并发数量的信号量</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewWorker</span><span class="hljs-params">(db *sql.DB, tableName <span class="hljs-type">string</span>, semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> *Worker &#123;<br>	<span class="hljs-keyword">return</span> &amp;Worker&#123;<br>		db:        db,<br>		tableName: tableName,<br>		semaphore: semaphore,<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// syncTable 函数执行分页查询并批量插入</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> syncTable() &#123;<br>	<span class="hljs-comment">// 分页查询 每个表中每个用户的未读消息数</span><br>	<span class="hljs-keyword">for</span> page := <span class="hljs-number">1</span>; ; page++ &#123;<br>		offset := (page - <span class="hljs-number">1</span>) * pageSize<br><br>		rows, err := w.db.Query(fmt.Sprintf(<span class="hljs-string">&quot;SELECT account_id, COUNT(1) AS unread_count FROM %s WHERE status = 0 GROUP BY account_id LIMIT %d OFFSET %d&quot;</span>, w.tableName, pageSize, offset))<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Printf(<span class="hljs-string">&quot;Error querying table %s: %s\n&quot;</span>, w.tableName, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br><br>		execStr := fmt.Sprintf(<span class="hljs-string">&quot;INSERT INTO t_user_message_read_%s (account_id, unread_num) VALUES &quot;</span>, w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):])<br>		<span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;<br>		count := <span class="hljs-number">0</span><br><br>		<span class="hljs-keyword">for</span> rows.Next() &#123;<br>			<span class="hljs-keyword">var</span> accountID, unreadCount <span class="hljs-type">int</span><br>			<span class="hljs-keyword">if</span> err := rows.Scan(&amp;accountID, &amp;unreadCount); err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Printf(<span class="hljs-string">&quot;Error scanning row: %s\n&quot;</span>, err)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br><br>			execStr += <span class="hljs-string">&quot;(?, ?),&quot;</span><br>			values = <span class="hljs-built_in">append</span>(values, accountID, unreadCount)<br>			count++<br><br>			<span class="hljs-keyword">if</span> count == batchSize &#123;<br>				<span class="hljs-keyword">if</span> err := w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>					fmt.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>					<span class="hljs-keyword">return</span><br>				&#125;<br><br>				<span class="hljs-comment">// 清空批量插入的语句和参数</span><br>				execStr = fmt.Sprintf(<span class="hljs-string">&quot;INSERT INTO t_user_message_read_%s (account_id, unread_num) VALUES &quot;</span>, w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):])<br>				values = []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">if</span> count == batchSize &#123;<br>			rows.Close()<br>			count = <span class="hljs-number">0</span><br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-comment">// 处理剩余的记录</span><br>		<span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;<br>			<span class="hljs-keyword">if</span> err := w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			rows.Close()<br>		&#125;<br><br>		<span class="hljs-comment">// 检查是否还有更多的记录</span><br>		<span class="hljs-keyword">if</span> count &lt; pageSize &#123;<br>			<span class="hljs-keyword">break</span><br>		&#125;<br><br>	&#125;<br><br>	fmt.Printf(<span class="hljs-string">&quot;Table %s synchronization completed.\n&quot;</span>, w.tableName)<br>&#125;<br><br><span class="hljs-comment">// execBatchInsert 函数执行批量插入操作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> execBatchInsert(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>	execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>	_, err := w.db.Exec(execStr, values...)<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	now := time.Now()<br><br>	<span class="hljs-comment">// 连接数据库</span><br>	db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;db_admin:dWjJdtCJH11JHinAn8$@tcp(songshutest.internal.cn-east-3.mysql.rds.myhuaweicloud.com:3306)/yx_user_message?charset=utf8mb4&amp;parseTime=true&amp;loc=Asia%2FShanghai&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;Error connecting to database: %s\n&quot;</span>, err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">defer</span> db.Close()<br><br>	<span class="hljs-comment">// 创建一个具有固定大小的信号量</span><br>	semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, channelBufSize)<br><br>	<span class="hljs-comment">// 创建等待组</span><br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; totalTables; i++ &#123;<br>		tableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_%x&quot;</span>, i)<br>		wg.Add(<span class="hljs-number">1</span>)<br>		semaphore &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// 获取一个信号量</span><br><br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tableName <span class="hljs-type">string</span>)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>				&lt;-semaphore <span class="hljs-comment">// 释放一个信号量</span><br>				wg.Done()<br>			&#125;()<br><br>			worker := NewWorker(db, tableName, semaphore)<br>			worker.syncTable()<br>		&#125;(tableName)<br>	&#125;<br><br>	<span class="hljs-comment">// 等待所有携程完成任务</span><br>	wg.Wait()<br><br>	fmt.Println(<span class="hljs-string">&quot;Data synchronization completed successfully.&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;Time taken:&quot;</span>, time.Since(now))<br>&#125;<br><br></code></pre></td></tr></table></figure>







<h4 id="有问题的-并发代码"><a href="#有问题的-并发代码" class="headerlink" title="有问题的 并发代码"></a>有问题的 并发代码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;database/sql&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	_ <span class="hljs-string">&quot;github.com/go-sql-driver/mysql&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>	pageSize       = <span class="hljs-number">2000</span>        <span class="hljs-comment">// 每页查询的记录数</span><br>	concurrency    = <span class="hljs-number">5</span>           <span class="hljs-comment">// 并发携程的数量</span><br>	batchSize      = <span class="hljs-number">2000</span>        <span class="hljs-comment">// 每次批量插入的记录数</span><br>	totalTables    = <span class="hljs-number">1</span>           <span class="hljs-comment">// 分表的总数</span><br>	channelBufSize = concurrency <span class="hljs-comment">// 信号量的缓冲区大小等于并发携程的数量</span><br>)<br><br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br><span class="hljs-keyword">type</span> Worker <span class="hljs-keyword">struct</span> &#123;<br>	db        *sql.DB<br>	tableName <span class="hljs-type">string</span><br>	semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; <span class="hljs-comment">// 用于控制并发数量的信号量</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewWorker</span><span class="hljs-params">(db *sql.DB, tableName <span class="hljs-type">string</span>, semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> *Worker &#123;<br>	<span class="hljs-keyword">return</span> &amp;Worker&#123;<br>		db:        db,<br>		tableName: tableName,<br>		semaphore: semaphore,<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// syncTable 函数执行分页查询并批量插入</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> syncTable() &#123;<br>	<span class="hljs-comment">// 查询每个表中每个用户的未读消息数</span><br>	<span class="hljs-comment">// 分页查询</span><br>	<span class="hljs-keyword">for</span> page := <span class="hljs-number">1</span>; ; page++ &#123;<br>		offset := (page - <span class="hljs-number">1</span>) * pageSize<br>		wg.Add(<span class="hljs-number">1</span>)<br>		w.semaphore &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br><br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(offset <span class="hljs-type">int</span>)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>				wg.Done()<br>				&lt;-w.semaphore<br>			&#125;()<br>			rows, err := w.db.Query(fmt.Sprintf(<span class="hljs-string">&quot;SELECT account_id, COUNT(1) AS unread_count FROM %s WHERE status = 0 GROUP BY account_id LIMIT %d OFFSET %d&quot;</span>, w.tableName, pageSize, offset))<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Printf(<span class="hljs-string">&quot;Error querying table %s: %s\n&quot;</span>, w.tableName, err)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br><br>			<span class="hljs-comment">// 构建批量插入的语句和参数</span><br>			execStr := <span class="hljs-string">&quot;INSERT INTO t_user_message_read_&quot;</span> + w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):] + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>			<span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;<br>			count := <span class="hljs-number">0</span><br><br>			<span class="hljs-keyword">for</span> rows.Next() &#123;<br>				<span class="hljs-keyword">var</span> accountID, unreadCount <span class="hljs-type">int</span><br>				<span class="hljs-keyword">if</span> err := rows.Scan(&amp;accountID, &amp;unreadCount); err != <span class="hljs-literal">nil</span> &#123;<br>					fmt.Printf(<span class="hljs-string">&quot;Error scanning row: %s\n&quot;</span>, err)<br>					<span class="hljs-keyword">return</span><br>				&#125;<br><br>				execStr += <span class="hljs-string">&quot;(?, ?),&quot;</span><br>				values = <span class="hljs-built_in">append</span>(values, accountID, unreadCount)<br>				count++<br><br>				<span class="hljs-keyword">if</span> count == batchSize &#123;<br>					<span class="hljs-comment">// 执行批量插入</span><br>					<span class="hljs-keyword">if</span> err := w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>						fmt.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>						<span class="hljs-keyword">return</span><br>					&#125;<br><br>					<span class="hljs-comment">// 清空批量插入的语句和参数</span><br>					execStr = <span class="hljs-string">&quot;INSERT INTO t_user_message_read_&quot;</span> + w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):] + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>				&#125;<br>			&#125;<br><br>			<span class="hljs-comment">// 处理剩余的记录</span><br>			<span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-keyword">if</span> err := w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>					fmt.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>				&#125;<br>				<span class="hljs-keyword">return</span><br>			&#125;<br><br>			rows.Close()<br>		&#125;(offset)<br>	&#125;<br><br>	fmt.Printf(<span class="hljs-string">&quot;Table %s synchronization completed.\n&quot;</span>, w.tableName)<br>&#125;<br><br><span class="hljs-comment">// execBatchInsert 函数执行批量插入操作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> execBatchInsert(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>	execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>	_, err := w.db.Exec(execStr, values...)<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	now := time.Now()<br><br>	<span class="hljs-comment">// 连接数据库</span><br>	db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;db_admin:dWjJdtCJH11JHinAn8$@tcp(songshutest.internal.cn-east-3.mysql.rds.myhuaweicloud.com:3306)/yx_user_message?charset=utf8mb4&amp;parseTime=true&amp;loc=Asia%2FShanghai&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;Error connecting to database: %s\n&quot;</span>, err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">defer</span> db.Close()<br><br>	<span class="hljs-comment">// 创建一个具有固定大小的信号量</span><br>	semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, channelBufSize)<br><br>	<span class="hljs-comment">// 遍历每个分表并启动携程进行数据同步</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; totalTables; i++ &#123;<br>		tableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_%x&quot;</span>, i)<br>		wg.Add(<span class="hljs-number">1</span>)<br>		semaphore &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// 获取一个信号量</span><br><br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tableName <span class="hljs-type">string</span>)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>				&lt;-semaphore <span class="hljs-comment">// 释放一个信号量</span><br>				wg.Done()<br>			&#125;()<br><br>			worker := NewWorker(db, tableName, semaphore)<br>			worker.syncTable()<br>		&#125;(tableName)<br>	&#125;<br><br>	<span class="hljs-comment">// 等待所有携程完成任务</span><br>	wg.Wait()<br><br>	fmt.Println(<span class="hljs-string">&quot;Data synchronization completed successfully.&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;Time taken:&quot;</span>, time.Since(now))<br>&#125;<br><br></code></pre></td></tr></table></figure>





<p>version</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;database/sql&quot;</span><br>   <span class="hljs-string">&quot;fmt&quot;</span><br>   <span class="hljs-string">&quot;sync&quot;</span><br>   <span class="hljs-string">&quot;time&quot;</span><br><br>   _ <span class="hljs-string">&quot;github.com/go-sql-driver/mysql&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>   pageSize       = <span class="hljs-number">5000</span>        <span class="hljs-comment">// 每页查询的记录数</span><br>   concurrency    = <span class="hljs-number">3</span>           <span class="hljs-comment">// 并发携程的数量</span><br>   batchSize      = <span class="hljs-number">5000</span>        <span class="hljs-comment">// 每次批量插入的记录数</span><br>   totalTables    = <span class="hljs-number">16</span>          <span class="hljs-comment">// 分表的总数</span><br>   channelBufSize = concurrency <span class="hljs-comment">// 信号量的缓冲区大小等于并发携程的数量</span><br>)<br><br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br><span class="hljs-keyword">type</span> Worker <span class="hljs-keyword">struct</span> &#123;<br>   db        *sql.DB<br>   tableName <span class="hljs-type">string</span><br>   semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; <span class="hljs-comment">// 用于控制并发数量的信号量</span><br>   mu        sync.Mutex    <span class="hljs-comment">// 用于保护共享变量的互斥锁</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewWorker</span><span class="hljs-params">(db *sql.DB, tableName <span class="hljs-type">string</span>, semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> *Worker &#123;<br>   <span class="hljs-keyword">return</span> &amp;Worker&#123;<br>      db:        db,<br>      tableName: tableName,<br>      semaphore: semaphore,<br>   &#125;<br>&#125;<br><br><span class="hljs-comment">// syncTable 函数执行分页查询并批量插入</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> syncTable() &#123;<br>   <span class="hljs-comment">// 查询每个表中每个用户的未读消息数</span><br>   <span class="hljs-comment">// 分页查询</span><br>   <span class="hljs-keyword">for</span> page := <span class="hljs-number">1</span>; ; page++ &#123;<br>      offset := (page - <span class="hljs-number">1</span>) * pageSize<br>      w.semaphore &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// 获取一个信号量</span><br><br>      rows, err := w.db.Query(fmt.Sprintf(<span class="hljs-string">&quot;SELECT account_id, COUNT(1) AS unread_count FROM %s WHERE status = 0 GROUP BY account_id LIMIT %d OFFSET %d&quot;</span>, w.tableName, pageSize, offset))<br>      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Printf(<span class="hljs-string">&quot;Error querying table %s: %s\n&quot;</span>, w.tableName, err)<br>         &lt;-w.semaphore <span class="hljs-comment">// 释放一个信号量</span><br>         <span class="hljs-keyword">continue</span><br>      &#125;<br><br>      <span class="hljs-comment">// 构建批量插入的语句和参数</span><br>      execStr := <span class="hljs-string">&quot;INSERT INTO t_user_message_read_&quot;</span> + w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):] + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>      <span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;<br>      count := <span class="hljs-number">0</span><br><br>      <span class="hljs-keyword">for</span> rows.Next() &#123;<br>         <span class="hljs-keyword">var</span> accountID, unreadCount <span class="hljs-type">int</span><br>         <span class="hljs-keyword">if</span> err := rows.Scan(&amp;accountID, &amp;unreadCount); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Printf(<span class="hljs-string">&quot;Error scanning row: %s\n&quot;</span>, err)<br>            &lt;-w.semaphore <span class="hljs-comment">// 释放一个信号量</span><br>            <span class="hljs-keyword">continue</span><br>         &#125;<br><br>         execStr += <span class="hljs-string">&quot;(?, ?),&quot;</span><br>         values = <span class="hljs-built_in">append</span>(values, accountID, unreadCount)<br>         count++<br><br>         <span class="hljs-keyword">if</span> count == batchSize &#123;<br>            <span class="hljs-comment">// 执行批量插入</span><br>            <span class="hljs-keyword">if</span> err := w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>               fmt.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>            &#125;<br><br>            <span class="hljs-comment">// 清空批量插入的语句和参数</span><br>            execStr = <span class="hljs-string">&quot;INSERT INTO t_user_message_read_&quot;</span> + w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):] + <span class="hljs-string">&quot; (account_id, unread_num) VALUES &quot;</span><br>            values = []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>         &#125;<br>      &#125;<br><br>      <span class="hljs-comment">// 处理剩余的记录</span><br>      <span class="hljs-keyword">if</span> count &lt; batchSize &#123;<br>         <span class="hljs-keyword">if</span> err = w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>         &#125;<br>      &#125;<br><br>      rows.Close()<br>      &lt;-w.semaphore <span class="hljs-comment">// 释放一个信号量</span><br>      <span class="hljs-comment">// 检查是否还有更多的记录</span><br>      <span class="hljs-keyword">if</span> count &lt; pageSize &#123;<br>         <span class="hljs-keyword">break</span><br>      &#125;<br>      count = <span class="hljs-number">0</span><br>   &#125;<br><br>   fmt.Printf(<span class="hljs-string">&quot;Table %s synchronization completed.\n&quot;</span>, w.tableName)<br>&#125;<br><br><span class="hljs-comment">// execBatchInsert 函数执行批量插入操作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> execBatchInsert(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>   w.mu.Lock()<br>   <span class="hljs-keyword">defer</span> w.mu.Unlock()<br><br>   execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>   _, err := w.db.Exec(execStr, values...)<br>   <span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>   now := time.Now()<br><br>   <span class="hljs-comment">// 连接数据库</span><br>   db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;db_admin:dWjJdtCJH11JHinAn8$@tcp(songshutest.internal.cn-east-3.mysql.rds.myhuaweicloud.com:3306)/yx_user_message?charset=utf8mb4&amp;parseTime=true&amp;loc=Asia%2FShanghai&quot;</span>)<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      fmt.Printf(<span class="hljs-string">&quot;Error connecting to database: %s\n&quot;</span>, err)<br>      <span class="hljs-keyword">return</span><br>   &#125;<br>   <span class="hljs-keyword">defer</span> db.Close()<br><br>   <span class="hljs-comment">// 创建一个具有固定大小的信号量</span><br>   semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, channelBufSize)<br><br>   <span class="hljs-comment">// 遍历每个分表并启动携程进行数据同步</span><br>   <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; totalTables; i++ &#123;<br>      tableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_%x&quot;</span>, i)<br>      wg.Add(<span class="hljs-number">1</span>)<br>      semaphore &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// 获取一个信号量</span><br><br>      <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tableName <span class="hljs-type">string</span>)</span></span> &#123;<br>         <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            &lt;-semaphore <span class="hljs-comment">// 释放一个信号量</span><br>            wg.Done()<br>         &#125;()<br><br>         worker := NewWorker(db, tableName, semaphore)<br>         worker.syncTable()<br>      &#125;(tableName)<br>   &#125;<br><br>   <span class="hljs-comment">// 等待所有携程完成任务</span><br>   wg.Wait()<br><br>   fmt.Println(<span class="hljs-string">&quot;Data synchronization completed successfully.&quot;</span>)<br>   fmt.Println(<span class="hljs-string">&quot;Time taken:&quot;</span>, time.Since(now))<br>&#125;<br></code></pre></td></tr></table></figure>









<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DELETE FROM t_user_message_read_0;<br>DELETE FROM t_user_message_read_1;<br>DELETE FROM t_user_message_read_2;<br>DELETE FROM t_user_message_read_3;<br>DELETE FROM t_user_message_read_4;<br>DELETE FROM t_user_message_read_5;<br>DELETE FROM t_user_message_read_6;<br>DELETE FROM t_user_message_read_7;<br>DELETE FROM t_user_message_read_8;<br>DELETE FROM t_user_message_read_9;<br>DELETE FROM t_user_message_read_a;<br>DELETE FROM t_user_message_read_b;<br>DELETE FROM t_user_message_read_c;<br>DELETE FROM t_user_message_read_d;<br>DELETE FROM t_user_message_read_e;<br>DELETE FROM t_user_message_read_f;<br><br></code></pre></td></tr></table></figure>









<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;database/sql&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;log&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	_ <span class="hljs-string">&quot;github.com/go-sql-driver/mysql&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>	pageSize       = <span class="hljs-number">2000</span><br>	concurrency    = <span class="hljs-number">5</span><br>	batchSize      = <span class="hljs-number">2000</span><br>	totalTables    = <span class="hljs-number">16</span><br>	channelBufSize = concurrency<br>)<br><br><span class="hljs-keyword">type</span> Worker <span class="hljs-keyword">struct</span> &#123;<br>	db        *sql.DB<br>	tableName <span class="hljs-type">string</span><br>	semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewWorker</span><span class="hljs-params">(db *sql.DB, tableName <span class="hljs-type">string</span>, semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> *Worker &#123;<br>	<span class="hljs-keyword">return</span> &amp;Worker&#123;<br>		db:        db,<br>		tableName: tableName,<br>		semaphore: semaphore,<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> syncTable(totalRows <span class="hljs-type">int</span>) &#123;<br>	totalPages := (totalRows + pageSize - <span class="hljs-number">1</span>) / pageSize<br><br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br>	<span class="hljs-keyword">for</span> page := <span class="hljs-number">1</span>; page &lt;= totalPages; page++ &#123;<br>		wg.Add(<span class="hljs-number">1</span>)<br>		w.semaphore &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(page <span class="hljs-type">int</span>)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>				wg.Done()<br>				&lt;-w.semaphore<br>			&#125;()<br><br>			offset := (page - <span class="hljs-number">1</span>) * pageSize<br><br>			rows, err := w.db.Query(fmt.Sprintf(<span class="hljs-string">&quot;SELECT account_id, COUNT(1) AS unread_count FROM %s WHERE status = 0 GROUP BY account_id LIMIT %d OFFSET %d&quot;</span>, w.tableName, pageSize, offset))<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				log.Printf(<span class="hljs-string">&quot;Error querying table %s: %s\n&quot;</span>, w.tableName, err)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			<span class="hljs-keyword">defer</span> rows.Close()<br><br>			execStr := fmt.Sprintf(<span class="hljs-string">&quot;INSERT INTO t_user_message_read_%s (account_id, unread_num) VALUES &quot;</span>, w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):])<br>			<span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;<br>			count := <span class="hljs-number">0</span><br><br>			<span class="hljs-keyword">for</span> rows.Next() &#123;<br>				<span class="hljs-keyword">var</span> accountID, unreadCount <span class="hljs-type">int</span><br>				<span class="hljs-keyword">if</span> err := rows.Scan(&amp;accountID, &amp;unreadCount); err != <span class="hljs-literal">nil</span> &#123;<br>					log.Printf(<span class="hljs-string">&quot;Error scanning row: %s\n&quot;</span>, err)<br>					<span class="hljs-keyword">return</span><br>				&#125;<br><br>				execStr += <span class="hljs-string">&quot;(?, ?),&quot;</span><br>				values = <span class="hljs-built_in">append</span>(values, accountID, unreadCount)<br>				count++<br><br>				<span class="hljs-keyword">if</span> count == batchSize &#123;<br>					<span class="hljs-keyword">if</span> err := w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>						log.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>						<span class="hljs-keyword">return</span><br>					&#125;<br><br>					execStr = fmt.Sprintf(<span class="hljs-string">&quot;INSERT INTO t_user_message_read_%s (account_id, unread_num) VALUES &quot;</span>, w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):])<br>					values = []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>				&#125;<br>			&#125;<br><br>			<span class="hljs-keyword">if</span> count &lt; batchSize &#123;<br>				<span class="hljs-keyword">if</span> err := w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>					log.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>					<span class="hljs-keyword">return</span><br>				&#125;<br>			&#125;<br>		&#125;(page)<br>	&#125;<br><br>	wg.Wait()<br>	log.Printf(<span class="hljs-string">&quot;Table %s synchronization completed.\n&quot;</span>, w.tableName)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> execBatchInsert(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>	execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>]<br>	_, err := w.db.Exec(execStr, values...)<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getTotalRows</span><span class="hljs-params">(db *sql.DB, tableName <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">var</span> totalRows <span class="hljs-type">int</span><br>	err := db.QueryRow(fmt.Sprintf(<span class="hljs-string">&quot;SELECT COUNT(DISTINCT account_id) FROM %s&quot;</span>, tableName)).Scan(&amp;totalRows)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> totalRows, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	now := time.Now()<br><br>	db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;db_admin:dWjJdtCJH11JHinAn8$@tcp(songshutest.internal.cn-east-3.mysql.rds.myhuaweicloud.com:3306)/yx_user_message?charset=utf8mb4&amp;parseTime=true&amp;loc=Asia%2FShanghai&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;Error connecting to database: %s\n&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">defer</span> db.Close()<br><br>	semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, channelBufSize)<br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; totalTables; i++ &#123;<br>		tableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_%x&quot;</span>, i)<br>		wg.Add(<span class="hljs-number">1</span>)<br>		semaphore &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br><br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tableName <span class="hljs-type">string</span>)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>				&lt;-semaphore<br>				wg.Done()<br>			&#125;()<br>			totalRows, err := getTotalRows(db, tableName)<br>			fmt.Printf(<span class="hljs-string">&quot;tableName: %s totalRows : %d\n&quot;</span>, tableName, totalRows)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				log.Printf(<span class="hljs-string">&quot;Error getting total rows for table %s: %s\n&quot;</span>, tableName, err)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			worker := NewWorker(db, tableName, semaphore)<br>			worker.syncTable(totalRows)<br>		&#125;(tableName)<br>	&#125;<br><br>	wg.Wait()<br><br>	log.Println(<span class="hljs-string">&quot;Data synchronization completed successfully.&quot;</span>)<br>	log.Println(<span class="hljs-string">&quot;Time taken:&quot;</span>, time.Since(now))<br>&#125;<br><br></code></pre></td></tr></table></figure>





<h4 id="周报"><a href="#周报" class="headerlink" title="周报"></a>周报</h4><p>督学监控系统</p>
<ul>
<li>督学监控系统成功上线</li>
<li>完善 督学监控系统的sop</li>
</ul>
<p>消息中心系统</p>
<ul>
<li>完成消息中心系统配置模块、短信配置模块、模版配置模块的开发</li>
<li>更新接口文档</li>
<li>编写一个通用的脚本用于自动生成*.go文件对应的_test.go文件；完成相应模块的单元测试</li>
<li>完成 同步历史用户未读消息数到t_user_message_read_*表的脚本</li>
</ul>
<p>总结：</p>
<p>​	先规划，后code</p>
<p>​	</p>
<p>ddj的脚本框架</p>
<p>存在就更新</p>
<p>insert 模式，范围，0-16（那张表？？）</p>
<p>update 指定时间. </p>
<p>​	account_id</p>
<p>user_msg_read_script </p>
<p>更新的</p>
<p>select account_id,</p>
<p>from t_user_message_*</p>
<p>group by acount_id</p>
<p>where updated &gt;since</p>
<p>一张表</p>
<p>在since后update的account_id  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs mysql">EXPLAIN UPDATE yx_user_message.t_user_message_read_0 AS t1<br>INNER JOIN (<br>    SELECT<br>        account_id,<br>        COUNT(*) AS unread_count<br>    FROM<br>        yx_user_message.t_user_message_0<br>    WHERE<br>        updated &gt; &#x27;2017-03-20 00:00:00&#x27; and `status`=0<br>    GROUP BY<br>        account_id<br>) AS t2 ON t1.account_id = t2.account_id<br>SET t1.unread_num = t2.unread_count;<br>	<br><br>  SELECT<br>        account_id,<br>        COUNT(*) AS unread_count<br>    FROM<br>        yx_user_message.t_user_message_0<br>    WHERE<br>        updated &gt; &#x27;2017-03-20 00:00:00&#x27; and `status`=0<br>    GROUP BY<br>        account_id<br></code></pre></td></tr></table></figure>





<p>实验</p>
<p>458940</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240322214848385.png" srcset="/img/loading.gif" lazyload alt="image-20240322214848385"></p>
<p>总结</p>
<p>reids</p>
<p>go的并发问题</p>
<h4 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> script<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;database/sql&quot;</span><br>   <span class="hljs-string">&quot;fmt&quot;</span><br>   <span class="hljs-string">&quot;sync&quot;</span><br>   <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> UpdateWorker <span class="hljs-keyword">struct</span> &#123;<br>   db        *sql.DB<br>   suffix    <span class="hljs-type">int</span><br>   wg        *sync.WaitGroup<br>   semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; <span class="hljs-comment">// 用于控制并发数量的信号量</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUpdateWorker</span><span class="hljs-params">(db *sql.DB, semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, wg *sync.WaitGroup, s <span class="hljs-type">int</span>)</span></span> *UpdateWorker &#123;<br>   <span class="hljs-keyword">return</span> &amp;UpdateWorker&#123;<br>      db:        db,<br>      semaphore: semaphore,<br>      wg:        wg,<br>      suffix:    s,<br>   &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *UpdateWorker)</span></span> syncTable(since <span class="hljs-type">string</span>) &#123;<br>   <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>      &lt;-w.semaphore <span class="hljs-comment">// 释放一个信号量</span><br>      w.wg.Done()<br>   &#125;()<br>   <span class="hljs-comment">// 将字符串格式的时间解析为 time.Time 类型</span><br>   sinceTime, err := time.Parse(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>, since)<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      fmt.Printf(<span class="hljs-string">&quot;Error parsing time: %s\n&quot;</span>, err)<br>      <span class="hljs-keyword">return</span><br>   &#125;<br><br>   <span class="hljs-comment">// 格式化时间为字符串</span><br>   sinceFormatted := sinceTime.Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>)<br><br>   <span class="hljs-comment">// 使用格式化后的时间进行 SQL 查询</span><br>   query := fmt.Sprintf(<span class="hljs-string">`</span><br><span class="hljs-string">   SELECT DISTINCT account_id</span><br><span class="hljs-string">   FROM t_user_message_%x</span><br><span class="hljs-string">   WHERE updated &gt; &#x27;%s&#x27;</span><br><span class="hljs-string">   `</span>, w.suffix, sinceFormatted)<br>   fmt.Printf(<span class="hljs-string">&quot;query: %s\n&quot;</span>, query)<br><br>   rows, err := w.db.Query(query)<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      fmt.Printf(<span class="hljs-string">&quot;Error querying account_id: %s\n&quot;</span>, err)<br>      <span class="hljs-keyword">return</span><br>   &#125;<br>   <span class="hljs-keyword">defer</span> rows.Close()<br><br>   <span class="hljs-comment">// 查询有更新的 account_id</span><br>   <span class="hljs-keyword">var</span> accountIDs []<span class="hljs-type">int</span><br>   <span class="hljs-keyword">for</span> rows.Next() &#123;<br>      <span class="hljs-keyword">var</span> accountID <span class="hljs-type">int</span><br>      <span class="hljs-keyword">if</span> err := rows.Scan(&amp;accountID); err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Printf(<span class="hljs-string">&quot;Error scanning account_id: %s\n&quot;</span>, err)<br>         <span class="hljs-keyword">return</span><br>      &#125;<br>      accountIDs = <span class="hljs-built_in">append</span>(accountIDs, accountID)<br>   &#125;<br>   fmt.Println(accountIDs)<br>   <span class="hljs-comment">// 使用得到的 account_id 更新相应的 unread_num 字段</span><br>   <span class="hljs-keyword">for</span> _, accountID := <span class="hljs-keyword">range</span> accountIDs &#123;<br>      updateQuery := fmt.Sprintf(<span class="hljs-string">`</span><br><span class="hljs-string">         UPDATE t_user_message_read_%x</span><br><span class="hljs-string">         SET unread_num = (</span><br><span class="hljs-string">            SELECT COUNT(*)</span><br><span class="hljs-string">            FROM t_user_message_%x</span><br><span class="hljs-string">            WHERE account_id = %d AND status = 0</span><br><span class="hljs-string">         )</span><br><span class="hljs-string">         WHERE account_id = %d</span><br><span class="hljs-string">      `</span>, w.suffix, w.suffix, accountID, accountID)<br><br>      _, err = w.db.Exec(updateQuery)<br>      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Printf(<span class="hljs-string">&quot;Error executing UPDATE query for account_id %d: %s\n&quot;</span>, accountID, err)<br>         <span class="hljs-keyword">return</span><br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> script<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;database/sql&quot;</span><br>   <span class="hljs-string">&quot;fmt&quot;</span><br>   <span class="hljs-string">&quot;sync&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> InsertWorker <span class="hljs-keyword">struct</span> &#123;<br>   db        *sql.DB<br>   tableName <span class="hljs-type">string</span><br>   wg        sync.WaitGroup<br>   semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; <span class="hljs-comment">// 用于控制并发数量的信号量</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewInsertWorker</span><span class="hljs-params">(tableName <span class="hljs-type">string</span>, db *sql.DB, semaphore <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, wg sync.WaitGroup)</span></span> *InsertWorker &#123;<br>   <span class="hljs-keyword">return</span> &amp;InsertWorker&#123;<br>      tableName: tableName,<br>      db:        db,<br>      semaphore: semaphore,<br>      wg:        wg,<br>   &#125;<br>&#125;<br><br><span class="hljs-comment">// syncTable 函数执行分页查询并批量插入</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *InsertWorker)</span></span> syncTable() &#123;<br>   <span class="hljs-comment">// 分页查询 每个表中每个用户的未读消息数</span><br>   <span class="hljs-keyword">for</span> page := <span class="hljs-number">1</span>; ; page++ &#123;<br>      offset := (page - <span class="hljs-number">1</span>) * pageSize<br><br>      rows, err := w.db.Query(fmt.Sprintf(<span class="hljs-string">&quot;SELECT account_id, COUNT(1) AS unread_count FROM %s WHERE status = 0 GROUP BY account_id LIMIT %d OFFSET %d&quot;</span>, w.tableName, pageSize, offset))<br>      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Printf(<span class="hljs-string">&quot;Error querying table %s: %s\n&quot;</span>, w.tableName, err)<br>         <span class="hljs-keyword">return</span><br>      &#125;<br><br>      execStr := fmt.Sprintf(<span class="hljs-string">&quot;INSERT INTO t_user_message_read_%s (account_id, unread_num) VALUES &quot;</span>, w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):])<br>      <span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;<br>      count := <span class="hljs-number">0</span><br><br>      <span class="hljs-keyword">for</span> rows.Next() &#123;<br>         <span class="hljs-keyword">var</span> accountID, unreadCount <span class="hljs-type">int</span><br>         <span class="hljs-keyword">if</span> err := rows.Scan(&amp;accountID, &amp;unreadCount); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Printf(<span class="hljs-string">&quot;Error scanning row: %s\n&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>         &#125;<br><br>         execStr += <span class="hljs-string">&quot;(?, ?),&quot;</span><br>         values = <span class="hljs-built_in">append</span>(values, accountID, unreadCount)<br>         count++<br><br>         <span class="hljs-keyword">if</span> count == batchSize &#123;<br>            <span class="hljs-keyword">if</span> err := w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>               fmt.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>               <span class="hljs-keyword">return</span><br>            &#125;<br><br>            <span class="hljs-comment">// 清空批量插入的语句和参数</span><br>            execStr = fmt.Sprintf(<span class="hljs-string">&quot;INSERT INTO t_user_message_read_%s (account_id, unread_num) VALUES &quot;</span>, w.tableName[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;t_user_message_&quot;</span>):])<br>            values = []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>         &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> count == batchSize &#123;<br>         rows.Close()<br>         count = <span class="hljs-number">0</span><br>         <span class="hljs-keyword">continue</span><br>      &#125;<br>      <span class="hljs-comment">// 处理剩余的记录</span><br>      <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;<br>         <span class="hljs-keyword">if</span> err := w.execBatchInsert(execStr, values); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Printf(<span class="hljs-string">&quot;Error executing batch insert: %s\n&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>         &#125;<br>         rows.Close()<br>      &#125;<br><br>      <span class="hljs-comment">// 检查是否还有更多的记录</span><br>      <span class="hljs-keyword">if</span> count &lt; pageSize &#123;<br>         <span class="hljs-keyword">break</span><br>      &#125;<br><br>   &#125;<br><br>   fmt.Printf(<span class="hljs-string">&quot;Table %s synchronization completed.\n&quot;</span>, w.tableName)<br>&#125;<br><br><span class="hljs-comment">// execBatchInsert 函数执行批量插入操作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *InsertWorker)</span></span> execBatchInsert(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>   execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>   _, err := w.db.Exec(execStr, values...)<br>   <span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure>





<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> script<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;database/sql&quot;</span><br>   <span class="hljs-string">&quot;fmt&quot;</span><br>   <span class="hljs-string">&quot;sync&quot;</span><br>   <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> (<br>   pageSize       = <span class="hljs-number">2000</span>        <span class="hljs-comment">// 每页查询的记录数</span><br>   concurrency    = <span class="hljs-number">8</span>           <span class="hljs-comment">// 并发携程的数量</span><br>   batchSize      = <span class="hljs-number">2500</span>        <span class="hljs-comment">// 每次批量插入的记录数</span><br>   totalTables    = <span class="hljs-number">16</span>          <span class="hljs-comment">// 分表的总数</span><br>   channelBufSize = concurrency <span class="hljs-comment">// 信号量的缓冲区大小等于并发携程的数量</span><br>   from           <span class="hljs-type">int</span><br>   to             <span class="hljs-type">int</span><br>)<br><br><span class="hljs-keyword">type</span> UserMsgReadScript <span class="hljs-keyword">struct</span> &#123;<br>   db *sql.DB<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserMsgReadScript</span><span class="hljs-params">(dsn <span class="hljs-type">string</span>)</span></span> *UserMsgReadScript &#123;<br>   db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, dsn)<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>   &#125;<br><br>   <span class="hljs-keyword">return</span> &amp;UserMsgReadScript&#123;<br>      db: db,<br>   &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *UserMsgReadScript)</span></span> InsertData(begin, end <span class="hljs-type">int</span>) (err <span class="hljs-type">error</span>) &#123;<br>   now := time.Now()<br>   from = begin<br>   to = end<br>   <span class="hljs-keyword">if</span> from &lt; <span class="hljs-number">0</span> &#123;<br>      from = <span class="hljs-number">0</span><br>   &#125;<br>   <span class="hljs-keyword">if</span> to &gt; totalTables &#123;<br>      to = totalTables<br>   &#125;<br>   <span class="hljs-keyword">defer</span> l.db.Close()<br><br>   semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, channelBufSize)<br>   <span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>   <span class="hljs-keyword">for</span> i := from; i &lt; to; i++ &#123;<br>      tableName := fmt.Sprintf(<span class="hljs-string">&quot;t_user_message_%x&quot;</span>, i)<br>      wg.Add(<span class="hljs-number">1</span>)<br>      semaphore &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// 获取一个信号量</span><br><br>      <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tableName <span class="hljs-type">string</span>)</span></span> &#123;<br>         <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            &lt;-semaphore <span class="hljs-comment">// 释放一个信号量</span><br>            wg.Done()<br>         &#125;()<br><br>         worker := NewInsertWorker(tableName, l.db, semaphore, wg)<br>         worker.syncTable()<br>      &#125;(tableName)<br>   &#125;<br>   <span class="hljs-comment">// 等待所有携程完成任务</span><br>   wg.Wait()<br><br>   fmt.Println(<span class="hljs-string">&quot;Data synchronization completed successfully.&quot;</span>)<br>   fmt.Println(<span class="hljs-string">&quot;Time taken:&quot;</span>, time.Since(now))<br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *UserMsgReadScript)</span></span> UpdateData(since <span class="hljs-type">string</span>, begin, end <span class="hljs-type">int</span>) (err <span class="hljs-type">error</span>) &#123;<br>   now := time.Now()<br>   from = begin<br>   to = end<br>   <span class="hljs-keyword">if</span> from &lt; <span class="hljs-number">0</span> &#123;<br>      from = <span class="hljs-number">0</span><br>   &#125;<br>   <span class="hljs-keyword">if</span> to &gt; totalTables &#123;<br>      to = totalTables<br>   &#125;<br>   semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, channelBufSize)<br>   <span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>   <span class="hljs-keyword">for</span> i := from; i &lt; to; i++ &#123;<br>      wg.Add(<span class="hljs-number">1</span>)<br>      semaphore &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// 获取一个信号量</span><br><br>      <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(suffix <span class="hljs-type">int</span>)</span></span> &#123;<br>         <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            &lt;-semaphore <span class="hljs-comment">// 释放一个信号量</span><br>            wg.Done()<br>         &#125;()<br><br>         worker := NewUpdateWorker(l.db, semaphore, &amp;wg, suffix)<br>         worker.syncTable(since)<br>      &#125;(i)<br>   &#125;<br>   <span class="hljs-comment">// 等待所有携程完成任务</span><br>   wg.Wait()<br><br>   fmt.Println(<span class="hljs-string">&quot;Data synchronization completed successfully.&quot;</span>)<br>   fmt.Println(<span class="hljs-string">&quot;Time taken:&quot;</span>, time.Since(now))<br><br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>





<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;flag&quot;</span><br>   <span class="hljs-string">&quot;fmt&quot;</span><br>   <span class="hljs-string">&quot;github.com/zeromicro/go-zero/core/conf&quot;</span><br>   <span class="hljs-string">&quot;github.com/zeromicro/go-zero/core/logx&quot;</span><br>   <span class="hljs-string">&quot;github.com/zeromicro/go-zero/rest&quot;</span><br>   <span class="hljs-string">&quot;log&quot;</span><br>   <span class="hljs-string">&quot;msgcenter/common/yxLog&quot;</span><br>   <span class="hljs-string">&quot;msgcenter/internal/config&quot;</span><br>   <span class="hljs-string">&quot;msgcenter/internal/script&quot;</span><br>   <span class="hljs-string">&quot;msgcenter/internal/svc&quot;</span><br>   <span class="hljs-string">&quot;msgcenter/service/openApi/handler&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> configFiles = flag.String(<span class="hljs-string">&quot;f&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;the config file&quot;</span>)<br><span class="hljs-keyword">var</span> event = flag.String(<span class="hljs-string">&quot;e&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;the event name&quot;</span>)<br><span class="hljs-keyword">var</span> begin = flag.Int(<span class="hljs-string">&quot;begin&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;从哪一张表开始同步&quot;</span>)<br><span class="hljs-keyword">var</span> end = flag.Int(<span class="hljs-string">&quot;end&quot;</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;同步到哪张表结束&quot;</span>)<br><span class="hljs-keyword">var</span> since = flag.String(<span class="hljs-string">&quot;s&quot;</span>, <span class="hljs-string">&quot;2024-03-20 00:00:00&quot;</span>, <span class="hljs-string">&quot;从什么时间点开始update&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>   flag.Parse()<br><br>   <span class="hljs-keyword">var</span> c config.Config<br>   conf.MustLoad(*configFiles, &amp;c)<br>   log.Printf(<span class="hljs-string">&quot;[openApi] mustLoad configFiles:%s finish&quot;</span>, *configFiles)<br><br>   udpLog := yxLog.NewClient(c.LogUdp, c.Name)<br>   <span class="hljs-keyword">defer</span> udpLog.Close()<br><br>   server := rest.MustNewServer(c.RestConf)<br>   <span class="hljs-comment">//server.AddRoute(middleware.MetricsRouter())</span><br>   <span class="hljs-keyword">defer</span> server.Stop()<br><br>   ctx := svc.NewServiceContext(c)<br>   handler.RegisterHandlers(server, ctx)<br><br>   writer := logx.NewWriter(udpLog)<br>   logx.SetWriter(writer)<br><br>   fmt.Println(<span class="hljs-string">&quot;event: &quot;</span>, *event)<br><br>   <span class="hljs-keyword">if</span> *event == <span class="hljs-string">&quot;insert&quot;</span> &#123;<br>      fmt.Println(<span class="hljs-string">&quot;insert event...&quot;</span>)<br>      fmt.Println(<span class="hljs-string">&quot;from:&quot;</span>, *begin, <span class="hljs-string">&quot; to:&quot;</span>, *end)<br>      script.NewUserMsgReadScript(c.YxUserMessageDB.DataSource).InsertData(*begin, *end)<br>   &#125;<br><br>   <span class="hljs-keyword">if</span> *event == <span class="hljs-string">&quot;update&quot;</span> &#123;<br>      fmt.Println(<span class="hljs-string">&quot;since:&quot;</span>, *since)<br>      fmt.Println(<span class="hljs-string">&quot;from:&quot;</span>, *begin, <span class="hljs-string">&quot; to:&quot;</span>, *end)<br>      script.NewUserMsgReadScript(c.YxUserMessageDB.DataSource).UpdateData(*since, *begin, *end)<br>   &#125;<br><br>   fmt.Println(<span class="hljs-string">&quot;scrip over....&quot;</span>)<br><br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">eg:<br>插入数据<br>```bash<br>go run main.go -f ../etc/test.yaml  -e=insert -begin=0 -end=3<br>```<br><br>更新数据<br>```bash<br>go run main.go -f ../etc/test.yaml  -e=update -begin=0 -end=3<br>```<br></code></pre></td></tr></table></figure>









<h2 id="第四周"><a href="#第四周" class="headerlink" title="第四周"></a>第四周</h2><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240325184358948.png" srcset="/img/loading.gif" lazyload alt="image-20240325184358948"></p>
<p>path</p>
<p>header</p>
<p>form</p>
<p>body </p>
<h4 id="脚本更新"><a href="#脚本更新" class="headerlink" title="脚本更新"></a>脚本更新</h4><p>insert</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> script<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;database/sql&quot;</span><br>   <span class="hljs-string">&quot;fmt&quot;</span><br>   <span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> InsertWorker <span class="hljs-keyword">struct</span> &#123;<br>   db     *sql.DB<br>   Suffix <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewInsertWorker</span><span class="hljs-params">(suffix <span class="hljs-type">int</span>, db *sql.DB)</span></span> *InsertWorker &#123;<br>   <span class="hljs-keyword">return</span> &amp;InsertWorker&#123;<br>      Suffix: suffix,<br>      db:     db,<br>   &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *InsertWorker)</span></span> syncTable() &#123;<br>   <span class="hljs-keyword">var</span> count <span class="hljs-type">int</span><br>   tableName := <span class="hljs-string">&quot;t_user_message_&quot;</span> + fmt.Sprintf(<span class="hljs-string">&quot;%x&quot;</span>, w.Suffix)<br>   <span class="hljs-keyword">for</span> page := <span class="hljs-number">1</span>; ; page++ &#123;<br>      offset := (page - <span class="hljs-number">1</span>) * pageSize<br>      count = <span class="hljs-number">0</span><br>      <span class="hljs-comment">// 分页查询 每个表中每个用户的总消息数和未读消息数</span><br>      queryStr := fmt.Sprintf(<span class="hljs-string">&quot;SELECT account_id, COUNT(1) AS total_num, SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) AS unread_num FROM %s GROUP BY account_id LIMIT %d OFFSET %d&quot;</span>, tableName, pageSize, offset)<br>      rows, err := w.db.Query(queryStr)<br>      fmt.Println(queryStr)<br>      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Printf(<span class="hljs-string">&quot;Error querying table %s: %s\n&quot;</span>, tableName, err)<br>         <span class="hljs-keyword">return</span><br>      &#125;<br>      <span class="hljs-keyword">var</span> execStr strings.Builder<br>      execStr.WriteString(fmt.Sprintf(<span class="hljs-string">&quot;INSERT INTO t_user_message_read_%x (account_id, total_num, unread_num) VALUES &quot;</span>, w.Suffix))<br>      <span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;<br><br>      <span class="hljs-keyword">for</span> rows.Next() &#123;<br>         <span class="hljs-keyword">var</span> accountID, totalNum, unreadNum <span class="hljs-type">int</span><br>         <span class="hljs-keyword">if</span> err = rows.Scan(&amp;accountID, &amp;totalNum, &amp;unreadNum); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Printf(<span class="hljs-string">&quot;Error scanning row: %s\n&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>         &#125;<br><br>         execStr.WriteString(<span class="hljs-string">&quot;(?, ?, ?),&quot;</span>)<br>         values = <span class="hljs-built_in">append</span>(values, accountID, totalNum, unreadNum)<br>         count++<br>      &#125;<br>      <span class="hljs-comment">// 移除最后一个逗号</span><br>      stmt, err := w.db.Prepare(execStr.String()[<span class="hljs-built_in">len</span>(execStr.String())<span class="hljs-number">-1</span>:])<br>      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Printf(<span class="hljs-string">&quot;Error preparing insert statement: %s\n&quot;</span>, err)<br>         <span class="hljs-keyword">return</span><br>      &#125;<br>      stmt.Close()<br>      rows.Close()<br><br>      <span class="hljs-comment">// 执行批量插入</span><br>      <span class="hljs-keyword">if</span> _, err = stmt.Exec(values...); err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Printf(<span class="hljs-string">&quot;Error inserting into t_user_message_read_%x: %s\n&quot;</span>, w.Suffix, err)<br>         <span class="hljs-keyword">return</span><br>      &#125;<br><br>      <span class="hljs-keyword">if</span> count &lt; pageSize &#123;<br>         <span class="hljs-keyword">break</span><br>      &#125;<br>   &#125;<br><br>   fmt.Printf(<span class="hljs-string">&quot;Table t_user_message_read_%x synchronization completed.\n&quot;</span>, w.Suffix)<br>&#125;<br><br><span class="hljs-comment">// execBatchInsert 函数执行批量插入操作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *InsertWorker)</span></span> execBatchInsert(execStr <span class="hljs-type">string</span>, values []<span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>   execStr = execStr[:<span class="hljs-built_in">len</span>(execStr)<span class="hljs-number">-1</span>] <span class="hljs-comment">// 去掉最后一个逗号</span><br>   _, err := w.db.Exec(execStr, values...)<br>   <span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure>







<p>update</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> script<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;database/sql&quot;</span><br>   <span class="hljs-string">&quot;fmt&quot;</span><br>   <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> UpdateWorker <span class="hljs-keyword">struct</span> &#123;<br>   db     *sql.DB<br>   suffix <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUpdateWorker</span><span class="hljs-params">(db *sql.DB, suffix <span class="hljs-type">int</span>)</span></span> *UpdateWorker &#123;<br>   <span class="hljs-keyword">return</span> &amp;UpdateWorker&#123;<br>      db:     db,<br>      suffix: suffix,<br>   &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *UpdateWorker)</span></span> syncTable(since <span class="hljs-type">string</span>) &#123;<br>   <span class="hljs-comment">// 将字符串格式的时间解析为 time.Time 类型</span><br>   sinceTime, err := time.Parse(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>, since)<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      fmt.Printf(<span class="hljs-string">&quot;Error parsing time: %s\n&quot;</span>, err)<br>      <span class="hljs-keyword">return</span><br>   &#125;<br><br>   <span class="hljs-comment">// 格式化时间为字符串</span><br>   sinceFormatted := sinceTime.Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>)<br><br>   query := fmt.Sprintf(<span class="hljs-string">`</span><br><span class="hljs-string">      SELECT DISTINCT account_id</span><br><span class="hljs-string">      FROM t_user_message_%x</span><br><span class="hljs-string">      WHERE updated &gt; &#x27;%s&#x27;</span><br><span class="hljs-string">   `</span>, w.suffix, sinceFormatted)<br><br>   rows, err := w.db.Query(query)<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      fmt.Printf(<span class="hljs-string">&quot;Error querying account_id: %s\n&quot;</span>, err)<br>      <span class="hljs-keyword">return</span><br>   &#125;<br>   <span class="hljs-keyword">defer</span> rows.Close()<br><br>   <span class="hljs-comment">// 查询有更新的 account_id</span><br>   <span class="hljs-keyword">var</span> accountIDs []<span class="hljs-type">int</span><br>   <span class="hljs-keyword">for</span> rows.Next() &#123;<br>      <span class="hljs-keyword">var</span> accountID <span class="hljs-type">int</span><br>      <span class="hljs-keyword">if</span> err = rows.Scan(&amp;accountID); err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Printf(<span class="hljs-string">&quot;Error scanning account_id: %s\n&quot;</span>, err)<br>         <span class="hljs-keyword">return</span><br>      &#125;<br>      accountIDs = <span class="hljs-built_in">append</span>(accountIDs, accountID)<br>   &#125;<br><br>   <span class="hljs-comment">// 使用得到的 account_id 更新相应的 total_num 和 unread_num 字段</span><br>   <span class="hljs-keyword">for</span> _, accountID := <span class="hljs-keyword">range</span> accountIDs &#123;<br>      insertQuery := fmt.Sprintf(<span class="hljs-string">`</span><br><span class="hljs-string">         INSERT INTO t_user_message_read_%x (account_id, total_num, unread_num, created)</span><br><span class="hljs-string">         SELECT account_id, COUNT(*) as total_count, SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) as unread_count, CURRENT_TIMESTAMP</span><br><span class="hljs-string">         FROM t_user_message_%x</span><br><span class="hljs-string">         WHERE account_id = %d</span><br><span class="hljs-string">         ON DUPLICATE KEY UPDATE</span><br><span class="hljs-string">            total_num = VALUES(total_num),</span><br><span class="hljs-string">            unread_num = VALUES(unread_num)</span><br><span class="hljs-string">      `</span>, w.suffix, w.suffix, accountID)<br><br>      _, err = w.db.Exec(insertQuery)<br>      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>         fmt.Printf(<span class="hljs-string">&quot;insertQuery query for account_id %d: %s\n&quot;</span>, accountID, err)<br>         <span class="hljs-keyword">return</span><br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>







<p>测试 插入一条数据到 t_user_message_0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs mysql">	INSERT INTO `yx_user_message`.`t_user_message_0` (<br>    `account_id`, <br>    `from_account_id`, <br>    `message_type`, <br>    `message_id`, <br>    `status`, <br>    `is_del`<br>) VALUES (<br>    3102526131924236,<br>    0,<br>    1,<br>    &#x27;your_message_id_here&#x27;,  -- 请替换为实际的消息ID<br>    0,<br>    0<br>);<br></code></pre></td></tr></table></figure>









<h4 id="log中间件"><a href="#log中间件" class="headerlink" title="log中间件"></a>log中间件</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> middleware<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;bytes&quot;</span><br>   <span class="hljs-string">&quot;encoding/json&quot;</span><br>   <span class="hljs-string">&quot;github.com/zeromicro/go-zero/core/iox&quot;</span><br>   yxLog <span class="hljs-string">&quot;gitlab.yx/base-service/go-sdk-yxlog&quot;</span><br>   <span class="hljs-string">&quot;golang.org/x/text/encoding/simplifiedchinese&quot;</span><br>   <span class="hljs-string">&quot;io&quot;</span><br>   <span class="hljs-string">&quot;io/ioutil&quot;</span><br>   <span class="hljs-string">&quot;net/http&quot;</span><br>   <span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> LogMiddleware <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewLogMiddleware</span><span class="hljs-params">()</span></span> *LogMiddleware &#123;<br>   <span class="hljs-keyword">return</span> &amp;LogMiddleware&#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">type</span> logResponseWriter <span class="hljs-keyword">struct</span> &#123;<br>   writer http.ResponseWriter<br>   code   <span class="hljs-type">int</span><br>   buf    *bytes.Buffer<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newLogResponseWriter</span><span class="hljs-params">(writer http.ResponseWriter, code <span class="hljs-type">int</span>)</span></span> *logResponseWriter &#123;<br>   <span class="hljs-keyword">var</span> buf bytes.Buffer<br>   <span class="hljs-keyword">return</span> &amp;logResponseWriter&#123;<br>      writer: writer,<br>      code:   code,<br>      buf:    &amp;buf,<br>   &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *logResponseWriter)</span></span> Write(bs []<span class="hljs-type">byte</span>) (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br>   w.buf.Write(bs)<br>   <span class="hljs-keyword">return</span> w.writer.Write(bs)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *logResponseWriter)</span></span> Header() http.Header &#123;<br>   <span class="hljs-keyword">return</span> w.writer.Header()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *logResponseWriter)</span></span> WriteHeader(code <span class="hljs-type">int</span>) &#123;<br>   w.code = code<br>   w.writer.WriteHeader(code)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *LogMiddleware)</span></span> Handle(next http.HandlerFunc) http.HandlerFunc &#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>      <span class="hljs-keyword">var</span> dup io.ReadCloser<br>      r.Body, dup = iox.DupReadCloser(r.Body)<br>      lwr := newLogResponseWriter(w, http.StatusOK)<br>      next(lwr, r)<br>      r.Body = dup<br>      m.logDetailLogic(r, lwr)<br>   &#125;<br>&#125;<br><br><span class="hljs-keyword">type</span> APILog <span class="hljs-keyword">struct</span> &#123;<br>   RequestUrl        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_url&quot;`</span><br>   RequestBodyParams <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_body_params&quot;`</span><br>   RequestFormParams <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_form_params&quot;`</span><br>   Response          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;response&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *LogMiddleware)</span></span> logDetailLogic(request *http.Request, response *logResponseWriter) &#123;<br><br>   reader := simplifiedchinese.GBK.NewDecoder().Reader(request.Body)<br>   body, _ := ioutil.ReadAll(reader)<br>   bodyStr := <span class="hljs-type">string</span>(body)<br>   bodyStr = strings.ReplaceAll(bodyStr, <span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>   bodyStr = strings.ReplaceAll(bodyStr, <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>   <span class="hljs-comment">// 解析表单数据</span><br>   <span class="hljs-keyword">var</span> formData strings.Builder<br>   <span class="hljs-keyword">if</span> err := request.ParseForm(); err != <span class="hljs-literal">nil</span> &#123;<br>      formData.WriteString(<span class="hljs-string">&quot;ParseForm error&quot;</span>)<br>   &#125;<br>   <span class="hljs-keyword">for</span> key, values := <span class="hljs-keyword">range</span> request.Form &#123;<br>      <span class="hljs-keyword">for</span> _, value := <span class="hljs-keyword">range</span> values &#123;<br>         formData.WriteString(key)<br>         formData.WriteString(<span class="hljs-string">&quot;=&quot;</span>)<br>         formData.WriteString(value)<br>         formData.WriteString(<span class="hljs-string">&quot;&amp;&quot;</span>)<br>      &#125;<br>   &#125;<br>   resp := response.buf.String()<br>   j, _ := json.Marshal(resp)<br><br>   apiLog := APILog&#123;<br>      RequestUrl:        request.RequestURI,<br>      RequestBodyParams: bodyStr,<br>      RequestFormParams: formData.String(),<br>      Response:          <span class="hljs-type">string</span>(j),<br>   &#125;<br><br>   logData, _ := json.Marshal(apiLog)<br>   logData = []<span class="hljs-type">byte</span>(strings.ReplaceAll(<span class="hljs-type">string</span>(logData), <span class="hljs-string">&quot;\\&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))<br>   yxLog.Infof(<span class="hljs-string">&quot;%s&quot;</span>, logData)<br><br>   <span class="hljs-comment">//if err != nil &#123;</span><br>   <span class="hljs-comment">// httpx.OkJson(w, errorx.NewErrorResponse(err))</span><br>   <span class="hljs-comment">//&#125; else &#123;</span><br>   <span class="hljs-comment">// httpx.OkJson(w, errorx.NewSuccess(resp))</span><br>   <span class="hljs-comment">//&#125;</span><br><br>&#125;<br></code></pre></td></tr></table></figure>











<p>中间件</p>
<p>脚本</p>
<h4 id="查询更新用户数量"><a href="#查询更新用户数量" class="headerlink" title="查询更新用户数量"></a>查询更新用户数量</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SET @start_time = &#x27;2024-03-01 00:00:00&#x27;;<br>-- 查询t_user_message_0<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_0 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_1<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_1 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_2<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_2 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_3<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_3 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_4<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_4 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_5<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_5 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_6<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_6 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_7<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_7 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_8<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_8 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_9<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_9 WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_a<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_a WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_b<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_b WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_c<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_c WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_d<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_d WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_e<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_e WHERE updated &gt; @start_time;<br><br>-- 查询t_user_message_f<br>SELECT COUNT(DISTINCT account_id) FROM t_user_message_f WHERE updated &gt; @start_time;<br><br><br><br><br>SELECT SUM(count) AS total_updated_users FROM (<br>    -- 查询t_user_message_0<br>    SELECT COUNT(DISTINCT account_id) AS count FROM t_user_message_0 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_1<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_1 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_2<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_2 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_3<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_3 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_4<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_4 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_5<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_5 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_6<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_6 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_7<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_7 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_8<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_8 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_9<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_9 WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_a<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_a WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_b<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_b WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_c<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_c WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_d<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_d WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_e<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_e WHERE updated &gt; @start_time<br>    UNION ALL<br>    -- 查询t_user_message_f<br>    SELECT COUNT(DISTINCT account_id) FROM t_user_message_f WHERE updated &gt; @start_time<br>) AS subquery;<br><br><br></code></pre></td></tr></table></figure>











<h4 id="user-模块开发"><a href="#user-模块开发" class="headerlink" title="user 模块开发"></a>user 模块开发</h4><p>getUserExtention 建表 分表 hash 缓存 db （两次db查询 user_extention ）</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240328223307381.png" srcset="/img/loading.gif" lazyload alt="image-20240328223307381"></p>
<h5 id="getSchoolList-接口"><a href="#getSchoolList-接口" class="headerlink" title="getSchoolList 接口"></a>getSchoolList 接口</h5><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240330095834566.png" srcset="/img/loading.gif" lazyload alt="image-20240330095834566"></p>
<h4 id="todolist-1"><a href="#todolist-1" class="headerlink" title="todolist"></a>todolist</h4><p>用户查询-&gt; 分库来查询？？ （谁来完成？？）</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240329090004923.png" srcset="/img/loading.gif" lazyload alt="image-20240329090004923"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240329093557221.png" srcset="/img/loading.gif" lazyload alt="image-20240329093557221"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> EditUserInfoExtensionRequest &#123;<br>   AccountID     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span><br>   RealName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_naem,optional&quot;`</span><br>   Sex           <span class="hljs-type">int8</span>   <span class="hljs-string">`json:&quot;sex,optional&quot;`</span><br>   Grade         <span class="hljs-type">int8</span>   <span class="hljs-string">`json:&quot;grade,optional&quot;`</span><br>   BirthDay      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday,optional&quot;`</span><br>   Province      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;province,optional&quot;`</span><br>   City          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;city,optional&quot;`</span><br>   Area          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;area,optional&quot;`</span><br>   OriSchoolID   <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;ori_school_id,optional&quot;`</span><br>   OriSchoolName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school_name,optional&quot;`</span><br>   Remark        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark,optional&quot;`</span><br>   BookVersion   <span class="hljs-type">int</span> <span class="hljs-string">`json:&quot;book_version,optional&quot;`</span><br>   SubjectID   <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;subject_id,optional&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> EditUserInfoExtensionResponse &#123;<br>   AccountID     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span><br>   OldUserID     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;old_user_id&quot;`</span><br>   UName         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span><br>   RealName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_name&quot;`</span><br>   Sex           <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;sex&quot;`</span><br>   Grade         <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;grade&quot;`</span><br>   Birthday      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday&quot;`</span><br>   Province      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;province&quot;`</span><br>   City          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;city&quot;`</span><br>   Area          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;area&quot;`</span><br>   OriSchoolID   <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;ori_school_id&quot;`</span><br>   OriSchoolName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school_name&quot;`</span><br>   Remark        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark&quot;`</span><br>   Created       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;created&quot;`</span><br>   Updated       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;updated&quot;`</span><br>   ProvinceName  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;province_name&quot;`</span><br>   CityName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;city_name&quot;`</span><br>   AreaName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;area_name&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>





<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">@doc <span class="hljs-string">&quot;获取用户扩展信息&quot;</span><br>@handler GetUserInfoExtension<br>post /user/getUserInfoExtension (GetUserInfoExtensionRequest) returns (GetUserInfoExtensionResponse)<br><br>@doc <span class="hljs-string">&quot;编辑用户扩展信息&quot;</span><br>@handler EditUserInfoExtension<br>post /user/editUserInfoExtension (EditUserInfoExtensionRequest) returns (EditUserInfoExtensionResponse)<br></code></pre></td></tr></table></figure>







<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TUserBasicFunc <span class="hljs-keyword">struct</span> &#123;<br>   AccountId         <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span>           <span class="hljs-comment">// 用户的account_id</span><br>   OldUserId         <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;old_user_id&quot;`</span>          <span class="hljs-comment">// 老系统user_id</span><br>   BatchNo           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;batch_no&quot;`</span>             <span class="hljs-comment">// 批次号</span><br>   Ahid              <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ahid&quot;`</span>                 <span class="hljs-comment">// 用户ACCOUNT_ID的MD5值</span><br>   Uname             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span>                <span class="hljs-comment">// 用户名</span><br>   AccountFlag       <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_flag&quot;`</span>         <span class="hljs-comment">// 用户标识1正式2测试用户</span><br>   Password          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;password&quot;`</span>             <span class="hljs-comment">// 用户密码</span><br>   OldPassword       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;old_password&quot;`</span>         <span class="hljs-comment">// 老系统迁移过来的密码</span><br>   Salt              <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;salt&quot;`</span>                 <span class="hljs-comment">// 密码盐</span><br>   Phone             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;phone&quot;`</span>                <span class="hljs-comment">// 手机</span><br>   Email             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;email&quot;`</span>                <span class="hljs-comment">// 用户邮箱</span><br>   Qq                <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;qq&quot;`</span>                   <span class="hljs-comment">// 用户QQ</span><br>   Wechat            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;wechat&quot;`</span>               <span class="hljs-comment">// 用户微信</span><br>   IsOld             <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_old&quot;`</span>               <span class="hljs-comment">// 是否老账号2为是 1为否</span><br>   IsVerify          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_verify&quot;`</span>            <span class="hljs-comment">// 是否认证2为是 1为否</span><br>   VerifyType        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;verify_type&quot;`</span>          <span class="hljs-comment">// 认证类型0未定义1微信验证2手机验证</span><br>   VerifyOpenid      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;verify_openid&quot;`</span>        <span class="hljs-comment">// 认证的微信openid</span><br>   VerifyPhone       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;verify_phone&quot;`</span>         <span class="hljs-comment">// 认证的手机号</span><br>   VerifyTime        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;verify_time&quot;`</span>          <span class="hljs-comment">// 认证时间</span><br>   AccountType       <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_type&quot;`</span>         <span class="hljs-comment">// 账号类型1学生2家长</span><br>   SchoolId          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;school_id&quot;`</span>            <span class="hljs-comment">// 账号来源学校</span><br>   OriSchool         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school&quot;`</span>           <span class="hljs-comment">// 就读学校</span><br>   Channel           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;channel&quot;`</span>              <span class="hljs-comment">// 账号来源渠道</span><br>   DataSource        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;data_source&quot;`</span>          <span class="hljs-comment">// 数据归属:0未定义1校长端2在线</span><br>   DataOrigin        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;data_origin&quot;`</span>          <span class="hljs-comment">// 数据初始来源:0未定义1校长端2在线3DL4家长端</span><br>   Nickname          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;nickname&quot;`</span>             <span class="hljs-comment">// 昵称</span><br>   RealName          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_name&quot;`</span>            <span class="hljs-comment">// 真实姓名</span><br>   Sex               <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;sex&quot;`</span>                  <span class="hljs-comment">// 性别0未定义1女2男</span><br>   UserStage         <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;user_stage&quot;`</span>           <span class="hljs-comment">// 阶段20通用30小学40初中50高中</span><br>   Grade             <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;grade&quot;`</span>                <span class="hljs-comment">// 年级20通用,1一年级,2二年级,3三年级,4四年级&#x27;&#x27;,5五年级,6六年级,7七年级,8八年级,9九年级,10高一,11高二,12高三</span><br>   ClassName         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;class_name&quot;`</span>           <span class="hljs-comment">// 班级</span><br>   Birthday          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday&quot;`</span>             <span class="hljs-comment">// 生日</span><br>   Province          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;province&quot;`</span>             <span class="hljs-comment">// 省份</span><br>   City              <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;city&quot;`</span>                 <span class="hljs-comment">// 省份</span><br>   Area              <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;area&quot;`</span>                 <span class="hljs-comment">// 区县</span><br>   Address           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;address&quot;`</span>              <span class="hljs-comment">// 详细地址</span><br>   Hobby             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;hobby&quot;`</span>                <span class="hljs-comment">// 兴趣爱好</span><br>   Remark            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark&quot;`</span>               <span class="hljs-comment">// 备注</span><br>   PadFirstLoginTime <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;pad_first_login_time&quot;`</span> <span class="hljs-comment">// PAD首次登录时间</span><br>   LastLoginTime     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;last_login_time&quot;`</span>      <span class="hljs-comment">// 最后登录时间</span><br>   LastLoginIp       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;last_login_ip&quot;`</span>        <span class="hljs-comment">// 最后登录IP</span><br>   SkipStatus        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;skip_status&quot;`</span>          <span class="hljs-comment">// 跳级状态;0未提交1未审核2驳回3审核通过</span><br>   Status            <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;status&quot;`</span>               <span class="hljs-comment">// 账号状态1正常2锁定</span><br>   AgreementStatus   <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;agreement_status&quot;`</span>     <span class="hljs-comment">// 协议状态1未开启2开启</span><br>   Avatar            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;avatar&quot;`</span>               <span class="hljs-comment">// 头像</span><br>   AvatarOld         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;avatar_old&quot;`</span>           <span class="hljs-comment">// 头像－用户中心上传</span><br>   <span class="hljs-comment">//Referrer          string `json:&quot;referrer&quot;`             // 推荐人</span><br>   ReferrerId     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;referrer_id&quot;`</span>     <span class="hljs-comment">// 推荐人account_id</span><br>   ReferrerMobile <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;referrer_mobile&quot;`</span> <span class="hljs-comment">// 推荐人手机</span><br>   IsGroup        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_group&quot;`</span>        <span class="hljs-comment">// 是否是组成员1为否2为是</span><br>   UserToken      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_token&quot;`</span>      <span class="hljs-comment">// 用户唯一令牌</span><br>   Created        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;created&quot;`</span>         <span class="hljs-comment">// 数据入库时间</span><br>   Updated        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;updated&quot;`</span>         <span class="hljs-comment">// 数据更新时间</span><br>   <span class="hljs-comment">//Autoutime         string `json:&quot;autoutime&quot;`</span><br>   IsGameUser    <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_game_user&quot;`</span> <span class="hljs-comment">// 默认为非游戏用户2  是游戏用户1</span><br>   SchoolName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;school_name&quot;`</span><br>   SchoolUseType <span class="hljs-type">int64</span> <span class="hljs-string">`json:&quot;school_use_type&quot;`</span><br>   SchoolType    <span class="hljs-type">int64</span> <span class="hljs-string">`json:&quot;school_type&quot;`</span><br>   ProvinceName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;province_name&quot;`</span><br>   CityName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;city_name&quot;`</span><br>   AreaName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;area_name&quot;`</span><br><br>&#125;<br></code></pre></td></tr></table></figure>









<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Code generated by goctl. DO NOT EDIT.</span><br><span class="hljs-keyword">package</span> types<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;user/model/teacherInfo&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> UserLoginRequest <span class="hljs-keyword">struct</span> &#123;<br>   AccountType  <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_type&quot;`</span><br>   Uname        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span><br>   Password     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;password&quot;`</span><br>   ClientParams <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;client_params&quot;`</span><br>   Channel      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;channel&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> UserLoginResponse <span class="hljs-keyword">struct</span> &#123;<br>   Avatar <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;avatar&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> TeacherLoginFunc <span class="hljs-keyword">struct</span> &#123;<br>   OldUserId <span class="hljs-type">int64</span> <span class="hljs-string">`json:&quot;old_user_id&quot;`</span><br>   teacherInfo.TTeacherInfo<br>&#125;<br><br><span class="hljs-keyword">type</span> TUserLoginFunc <span class="hljs-keyword">struct</span> &#123;<br>   Id          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;id&quot;`</span>           <span class="hljs-comment">// 自增ID</span><br>   AccountId   <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span>   <span class="hljs-comment">// 用户的account_id</span><br>   AccountType <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_type&quot;`</span> <span class="hljs-comment">// 用户类型1学生2家长3老师</span><br>   LoginType   <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;login_type&quot;`</span>   <span class="hljs-comment">// 登录类型1用户名登录2手机号登录</span><br>   Uname       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span>        <span class="hljs-comment">// 用户名/登录名</span><br>   Password    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;password&quot;`</span>     <span class="hljs-comment">// 用户密码</span><br>   Salt        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;salt&quot;`</span>         <span class="hljs-comment">// 密码盐</span><br>   Channel     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;channel&quot;`</span>      <span class="hljs-comment">// 来源渠道</span><br>   Created     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;created&quot;`</span>      <span class="hljs-comment">// 数据入库时间</span><br>   Updated     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;updated&quot;`</span>      <span class="hljs-comment">// 数据更新时间</span><br>&#125;<br><br><span class="hljs-keyword">type</span> AddUserRequest <span class="hljs-keyword">struct</span> &#123;<br>   Uname           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span><br>   Password        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;password&quot;`</span><br>   Nickname        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;nickname,optional&quot;`</span><br>   RealName        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_name,optional,default&quot;`</span><br>   Sex             <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;sex,optional&quot;`</span><br>   UserStage       <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;user_stage,optional&quot;`</span><br>   Grade           <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;grade,optional&quot;`</span><br>   Phone           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;phone,optional&quot;`</span><br>   Email           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;email,optional&quot;`</span><br>   Qq              <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;qq,optional&quot;`</span><br>   Wechat          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;wechat,optional&quot;`</span><br>   Province        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;province,optional&quot;`</span><br>   City            <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;city,optional&quot;`</span><br>   Area            <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;area,optional&quot;`</span><br>   Address         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;address,optional&quot;`</span><br>   Hobby           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;hobby,optional&quot;`</span><br>   Remark          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark,optional&quot;`</span><br>   Avatar          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;avatar,optional&quot;`</span><br>   AgreementStatus <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;agreement_status,optional&quot;`</span><br>   ReferrerId      <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;referrer_id,optional&quot;`</span><br>   ReferrerMobile  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;referrer_mobile,optional&quot;`</span><br>   Birthday        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday,optional&quot;`</span><br>   ClassName       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;class_name,optional&quot;`</span><br>   Channel         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;channel,optional&quot;`</span><br>   SchoolId        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;school_id,optional&quot;`</span><br>   OriSchool       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school,optional&quot;`</span><br>   DataOrigin      <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;data_origin,optional,options=[0,1,2,3,4,5,6,7,8,10],default=1&quot;`</span><br>   DataSource      <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;data_source,optional,options=[0,1,2,3],default=1&quot;`</span><br>   AccountType     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_type,optional,options=[1,2],default=1&quot;`</span><br>   AccountFlag     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_flag,optional,options=[1,2,10,11],default=1&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> AddUserResponse <span class="hljs-keyword">struct</span> &#123;<br>   AccountId         <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span><br>   OldUserID         <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;old_user_id&quot;`</span><br>   BatchNo           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;batch_no&quot;`</span><br>   Ahid              <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ahid&quot;`</span><br>   Uname             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span><br>   AccountFlag       <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_flag&quot;`</span><br>   Phone             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;phone&quot;`</span><br>   Email             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;email&quot;`</span><br>   Qq                <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;qq&quot;`</span><br>   Wechat            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;wechat&quot;`</span><br>   IsOld             <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_old&quot;`</span><br>   IsVerify          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_verify&quot;`</span><br>   VerifyType        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;verify_type&quot;`</span><br>   VerifyOpenid      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;verify_openid&quot;`</span><br>   VerifyPhone       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;verify_phone&quot;`</span><br>   VerifyTime        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;verify_time&quot;`</span><br>   AccountType       <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_type&quot;`</span><br>   SchoolId          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;school_id&quot;`</span><br>   OriSchool         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school&quot;`</span><br>   Channel           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;channel&quot;`</span><br>   DataSource        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;data_source&quot;`</span><br>   DataOrigin        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;data_origin&quot;`</span><br>   Nickname          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;nickname&quot;`</span><br>   RealName          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_name&quot;`</span><br>   Sex               <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;sex&quot;`</span><br>   UserStage         <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;user_stage&quot;`</span><br>   Grade             <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;grade&quot;`</span><br>   ClassName         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;class_name&quot;`</span><br>   Birthday          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday&quot;`</span><br>   Province          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;province&quot;`</span><br>   City              <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;city&quot;`</span><br>   Area              <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;area&quot;`</span><br>   Address           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;address&quot;`</span><br>   Hobby             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;hobby&quot;`</span><br>   Remark            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark&quot;`</span><br>   PadFirstLoginTime <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;pad_first_login_time&quot;`</span><br>   LastLoginTime     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;last_login_time&quot;`</span><br>   LastLoginIp       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;last_login_ip&quot;`</span><br>   SkipStatus        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;skip_status&quot;`</span><br>   Status            <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;status&quot;`</span><br>   AgreementStatus   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;agreement_status&quot;`</span><br>   Avatar            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;avatar&quot;`</span><br>   AvatarOld         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;avatar_old&quot;`</span><br>   ReferrerId        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;referrer_id&quot;`</span><br>   ReferrerMobile    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;referrer_mobile&quot;`</span><br>   IsGroup           <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_group&quot;`</span><br>   UserToken         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_token&quot;`</span><br>   IsGameUser        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_game_user&quot;`</span><br>   Created           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;created&quot;`</span><br>   Updated           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;updated&quot;`</span><br>   SchoolName        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;school_name&quot;`</span><br>   SchoolUseType     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;school_use_type&quot;`</span><br>   SchoolType        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;school_type&quot;`</span><br>   ProvinceName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;province_name&quot;`</span><br>   CityName          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;city_name&quot;`</span><br>   AreaName          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;area_name&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> TUserBasicFunc <span class="hljs-keyword">struct</span> &#123;<br>   AccountId         <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span>           <span class="hljs-comment">// 用户的account_id</span><br>   OldUserId         <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;old_user_id&quot;`</span>          <span class="hljs-comment">// 老系统user_id</span><br>   BatchNo           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;batch_no&quot;`</span>             <span class="hljs-comment">// 批次号</span><br>   Ahid              <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ahid&quot;`</span>                 <span class="hljs-comment">// 用户ACCOUNT_ID的MD5值</span><br>   Uname             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span>                <span class="hljs-comment">// 用户名</span><br>   AccountFlag       <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_flag&quot;`</span>         <span class="hljs-comment">// 用户标识1正式2测试用户</span><br>   Password          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;password&quot;`</span>             <span class="hljs-comment">// 用户密码</span><br>   OldPassword       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;old_password&quot;`</span>         <span class="hljs-comment">// 老系统迁移过来的密码</span><br>   Salt              <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;salt&quot;`</span>                 <span class="hljs-comment">// 密码盐</span><br>   Phone             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;phone&quot;`</span>                <span class="hljs-comment">// 手机</span><br>   Email             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;email&quot;`</span>                <span class="hljs-comment">// 用户邮箱</span><br>   Qq                <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;qq&quot;`</span>                   <span class="hljs-comment">// 用户QQ</span><br>   Wechat            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;wechat&quot;`</span>               <span class="hljs-comment">// 用户微信</span><br>   IsOld             <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_old&quot;`</span>               <span class="hljs-comment">// 是否老账号2为是 1为否</span><br>   IsVerify          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_verify&quot;`</span>            <span class="hljs-comment">// 是否认证2为是 1为否</span><br>   VerifyType        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;verify_type&quot;`</span>          <span class="hljs-comment">// 认证类型0未定义1微信验证2手机验证</span><br>   VerifyOpenid      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;verify_openid&quot;`</span>        <span class="hljs-comment">// 认证的微信openid</span><br>   VerifyPhone       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;verify_phone&quot;`</span>         <span class="hljs-comment">// 认证的手机号</span><br>   VerifyTime        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;verify_time&quot;`</span>          <span class="hljs-comment">// 认证时间</span><br>   AccountType       <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_type&quot;`</span>         <span class="hljs-comment">// 账号类型1学生2家长</span><br>   SchoolId          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;school_id&quot;`</span>            <span class="hljs-comment">// 账号来源学校</span><br>   OriSchool         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school&quot;`</span>           <span class="hljs-comment">// 就读学校</span><br>   Channel           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;channel&quot;`</span>              <span class="hljs-comment">// 账号来源渠道</span><br>   DataSource        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;data_source&quot;`</span>          <span class="hljs-comment">// 数据归属:0未定义1校长端2在线</span><br>   DataOrigin        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;data_origin&quot;`</span>          <span class="hljs-comment">// 数据初始来源:0未定义1校长端2在线3DL4家长端</span><br>   Nickname          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;nickname&quot;`</span>             <span class="hljs-comment">// 昵称</span><br>   RealName          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_name&quot;`</span>            <span class="hljs-comment">// 真实姓名</span><br>   Sex               <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;sex&quot;`</span>                  <span class="hljs-comment">// 性别0未定义1女2男</span><br>   UserStage         <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;user_stage&quot;`</span>           <span class="hljs-comment">// 阶段20通用30小学40初中50高中</span><br>   Grade             <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;grade&quot;`</span>                <span class="hljs-comment">// 年级20通用,1一年级,2二年级,3三年级,4四年级&#x27;&#x27;,5五年级,6六年级,7七年级,8八年级,9九年级,10高一,11高二,12高三</span><br>   ClassName         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;class_name&quot;`</span>           <span class="hljs-comment">// 班级</span><br>   Birthday          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday&quot;`</span>             <span class="hljs-comment">// 生日</span><br>   Province          <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;province&quot;`</span>             <span class="hljs-comment">// 省份</span><br>   City              <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;city&quot;`</span>                 <span class="hljs-comment">// 省份</span><br>   Area              <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;area&quot;`</span>                 <span class="hljs-comment">// 区县</span><br>   Address           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;address&quot;`</span>              <span class="hljs-comment">// 详细地址</span><br>   Hobby             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;hobby&quot;`</span>                <span class="hljs-comment">// 兴趣爱好</span><br>   Remark            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark&quot;`</span>               <span class="hljs-comment">// 备注</span><br>   PadFirstLoginTime <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;pad_first_login_time&quot;`</span> <span class="hljs-comment">// PAD首次登录时间</span><br>   LastLoginTime     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;last_login_time&quot;`</span>      <span class="hljs-comment">// 最后登录时间</span><br>   LastLoginIp       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;last_login_ip&quot;`</span>        <span class="hljs-comment">// 最后登录IP</span><br>   SkipStatus        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;skip_status&quot;`</span>          <span class="hljs-comment">// 跳级状态;0未提交1未审核2驳回3审核通过</span><br>   Status            <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;status&quot;`</span>               <span class="hljs-comment">// 账号状态1正常2锁定</span><br>   AgreementStatus   <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;agreement_status&quot;`</span>     <span class="hljs-comment">// 协议状态1未开启2开启</span><br>   Avatar            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;avatar&quot;`</span>               <span class="hljs-comment">// 头像</span><br>   AvatarOld         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;avatar_old&quot;`</span>           <span class="hljs-comment">// 头像－用户中心上传</span><br>   <span class="hljs-comment">//Referrer          string `json:&quot;referrer&quot;`             // 推荐人</span><br>   ReferrerId     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;referrer_id&quot;`</span>     <span class="hljs-comment">// 推荐人account_id</span><br>   ReferrerMobile <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;referrer_mobile&quot;`</span> <span class="hljs-comment">// 推荐人手机</span><br>   IsGroup        <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_group&quot;`</span>        <span class="hljs-comment">// 是否是组成员1为否2为是</span><br>   UserToken      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_token&quot;`</span>      <span class="hljs-comment">// 用户唯一令牌</span><br>   Created        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;created&quot;`</span>         <span class="hljs-comment">// 数据入库时间</span><br>   Updated        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;updated&quot;`</span>         <span class="hljs-comment">// 数据更新时间</span><br>   <span class="hljs-comment">//Autoutime         string `json:&quot;autoutime&quot;`</span><br>   IsGameUser    <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;is_game_user&quot;`</span> <span class="hljs-comment">// 默认为非游戏用户2  是游戏用户1</span><br>   SchoolName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;school_name&quot;`</span><br>   SchoolUseType <span class="hljs-type">int64</span> <span class="hljs-string">`json:&quot;school_use_type&quot;`</span><br>   SchoolType    <span class="hljs-type">int64</span> <span class="hljs-string">`json:&quot;school_type&quot;`</span><br>   ProvinceName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;province_name&quot;`</span><br>   CityName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;city_name&quot;`</span><br>   AreaName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;area_name&quot;`</span><br><br>&#125;<br><span class="hljs-keyword">type</span> GetChannelMapRequest <span class="hljs-keyword">struct</span> &#123;<br>   Channel <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;channel&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> GetUserInfoExtensionRequest <span class="hljs-keyword">struct</span> &#123;<br>   AccountId <span class="hljs-type">int64</span> <span class="hljs-string">`json:&quot;account_id&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> GetUserInfoExtensionResponse <span class="hljs-keyword">struct</span> &#123;<br>   AccountId     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span><br>   OldUserID     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;old_user_id&quot;`</span><br>   UName         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span><br>   RealName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_name&quot;`</span><br>   Sex           <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;sex&quot;`</span><br>   Grad          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;grade&quot;`</span> <span class="hljs-comment">//年级:0未定义1一年级,2二年级,3三年级,4四年级&#x27;&#x27;,5五年级,6六年级,7七年级,8八年级,9九年级,10高一,11高二,12高三</span><br>   Birthday      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday&quot;`</span><br>   Province      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;province&quot;`</span><br>   City          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;city&quot;`</span><br>   Area          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;area&quot;`</span><br>   ProvinceName  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;province_name&quot;`</span><br>   CityName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;city_name&quot;`</span><br>   AreaName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;area_name&quot;`</span><br>   OriSchoolID   <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;ori_school_id&quot;`</span>   <span class="hljs-comment">//就读公校id</span><br>   OriSchoolName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school_name&quot;`</span> <span class="hljs-comment">//就读公校名称</span><br>   Remark        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark&quot;`</span>          <span class="hljs-comment">//备注</span><br>   Created       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;created&quot;`</span><br>   Updated       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;updated&quot;`</span><br>   ExtendStatus  <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;extend_status&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>







<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> EditUserInfoExtensionRequest <span class="hljs-keyword">struct</span> &#123;<br>   AccountID     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span><br>   RealName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_naem,optional&quot;`</span><br>   Sex           <span class="hljs-type">int8</span>   <span class="hljs-string">`json:&quot;sex,optional&quot;`</span><br>   Grade         <span class="hljs-type">int8</span>   <span class="hljs-string">`json:&quot;grade,optional&quot;`</span><br>   BirthDay      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday,optional&quot;`</span><br>   Province      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;province,optional&quot;`</span><br>   City          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;city,optional&quot;`</span><br>   Area          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;area,optional&quot;`</span><br>   OriSchoolID   <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;ori_school_id,optional&quot;`</span><br>   OriSchoolName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school_name,optional&quot;`</span><br>   Remark        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark,optional&quot;`</span><br>   BookVersion   <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;book_version,optional&quot;`</span><br>   SubjectID     <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;subject_id,optional&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> EditUserInfoExtensionResponse <span class="hljs-keyword">struct</span> &#123;<br>   AccountID     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span><br>   OldUserID     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;old_user_id&quot;`</span><br>   UName         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span><br>   RealName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_name&quot;`</span><br>   Sex           <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;sex&quot;`</span><br>   Grade         <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;grade&quot;`</span><br>   Birthday      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday&quot;`</span><br>   Province      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;province&quot;`</span><br>   City          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;city&quot;`</span><br>   Area          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;area&quot;`</span><br>   OriSchoolID   <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;ori_school_id&quot;`</span><br>   OriSchoolName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school_name&quot;`</span><br>   Remark        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark&quot;`</span><br>   Created       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;created&quot;`</span><br>   Updated       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;updated&quot;`</span><br>   ProvinceName  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;province_name&quot;`</span><br>   CityName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;city_name&quot;`</span><br>   AreaName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;area_name&quot;`</span><br>&#125;<br><span class="hljs-keyword">type</span> GetUserInfoExtensionRequest <span class="hljs-keyword">struct</span> &#123;<br>   AccountId <span class="hljs-type">int64</span> <span class="hljs-string">`json:&quot;account_id&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> GetUserInfoExtensionResponse <span class="hljs-keyword">struct</span> &#123;<br>   AccountId     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;account_id&quot;`</span><br>   OldUserID     <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;old_user_id&quot;`</span><br>   UName         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;uname&quot;`</span><br>   RealName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;real_name&quot;`</span><br>   Sex           <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;sex&quot;`</span><br>   Grad          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;grade&quot;`</span> <span class="hljs-comment">//年级:0未定义1一年级,2二年级,3三年级,4四年级&#x27;&#x27;,5五年级,6六年级,7七年级,8八年级,9九年级,10高一,11高二,12高三</span><br>   Birthday      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;birthday&quot;`</span><br>   Province      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;province&quot;`</span><br>   City          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;city&quot;`</span><br>   Area          <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;area&quot;`</span><br>   ProvinceName  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;province_name&quot;`</span><br>   CityName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;city_name&quot;`</span><br>   AreaName      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;area_name&quot;`</span><br>   OriSchoolID   <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;ori_school_id&quot;`</span>   <span class="hljs-comment">//就读公校id</span><br>   OriSchoolName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;ori_school_name&quot;`</span> <span class="hljs-comment">//就读公校名称</span><br>   Remark        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;remark&quot;`</span>          <span class="hljs-comment">//备注</span><br>   Created       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;created&quot;`</span><br>   Updated       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;updated&quot;`</span><br>   ExtendStatus  <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;extend_status&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>





<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240330151211692.png" srcset="/img/loading.gif" lazyload alt="image-20240330151211692"></p>
<p>schoolList </p>
<h4 id="准备面试"><a href="#准备面试" class="headerlink" title="准备面试"></a>准备面试</h4><p>map  </p>
<p>使用拉链法的hashMap</p>
<p>结构：槽里面有bucket，每个bucket中存放了能存放8个key val hashVal ，若数据多余八个，则放到溢出桶中；</p>
<p>​	hash的读 :先确定桶，在哪一个桶中-》比较前八位的hash值，如果相同比较key是否相同；如果在桶中不存在，则去溢出桶中寻找；否则数据不存在</p>
<p>​	hash的写：同样的确定在哪一个桶中，进行相应的写操作</p>
<p>扩容逻辑：</p>
<p>MQ <a target="_blank" rel="noopener" href="https://houbb.github.io/2022/05/10/interview-07-mq">mq 常见面试题汇总 | Echo Blog (houbb.github.io)</a></p>
<h2 id="第一个月的总结"><a href="#第一个月的总结" class="headerlink" title="第一个月的总结"></a>第一个月的总结</h2><ol>
<li>工作内容</li>
</ol>
<blockquote>
<p>督学统计日志处理</p>
<ul>
<li>项目状态：已于3月18上线</li>
<li>项目描述：将本地日志转发至UDP日志服务器</li>
</ul>
</blockquote>
<blockquote>
<h4 id="go脚手架"><a href="#go脚手架" class="headerlink" title="go脚手架"></a>go脚手架</h4><ul>
<li>添加接口日志中间件，已投入用户中心、消息中心、账号中心使用</li>
<li>补充技术文档 <a target="_blank" rel="noopener" href="http://wiki.classba.com.cn/pages/viewpage.action?pageId=64430227">http://wiki.classba.com.cn/pages/viewpage.action?pageId=64430227</a></li>
</ul>
</blockquote>
<blockquote>
<h4 id="消息中心开发"><a href="#消息中心开发" class="headerlink" title="消息中心开发"></a>消息中心开发</h4><p>项目状态：已于3月28日上线 接口开发，具体为smsConfig、smsTemplate、systemConfig 模块的接口，共计9个接口数据同步脚本编写，具体为 一个通用的脚本用于自动生成*.go文件对应的_test.go文件框架单元测试及测试脚本编写，具体为 同步历史用户未读消息数到t_user_message_read_*表中</p>
</blockquote>
<blockquote>
<h4 id="用户中心开发"><a href="#用户中心开发" class="headerlink" title="用户中心开发"></a>用户中心开发</h4><p>项目状态：已于4月3日提测接口开发 具体为getUserextension、editUserextension、getschoolList三个接口；单元测试</p>
</blockquote>
<ol start="2">
<li>学习与成长</li>
</ol>
<blockquote>
<p>通过公司的实践机会，我在多个方面取得了显著进步：</p>
</blockquote>
<blockquote>
<p><strong>流程与规范</strong>：了解了公司的提测流程和各种开发规范。<strong>技术能力</strong>：掌握了定时脚本处理、异步处理、以及解决缓存和数据库数据不一致问题的方法。<strong>编码质量</strong>：加强了代码设计的通用性，提高了代码的可维护性和可扩展性。</p>
</blockquote>
<ol start="3">
<li>不足之处</li>
</ol>
<blockquote>
<p><strong>业务能力</strong>：虽然有所进步，但仍需提高业务处理能力，以便能够独立完成复杂的开发任务。<strong>沟通能力</strong>：需要进一步提高沟通水平，能够更加积极主动地与团队成员、同事和合作伙伴进行有效沟通，及时提出问题并共同解决。</p>
</blockquote>
<ol start="4">
<li>未来计划</li>
</ol>
<blockquote>
<p><strong>技术提升</strong></p>
</blockquote>
<blockquote>
<blockquote>
<p>掌握不熟悉的组件，如 ES、Kafka 和 MQ。 能够独立在业务处理中使用这些组件</p>
</blockquote>
</blockquote>
<blockquote>
<p><strong>业务提升</strong></p>
</blockquote>
<blockquote>
<blockquote>
<p>尝试解决客诉、慢日志处理等需求形成自己的业务处理、思考逻辑</p>
</blockquote>
</blockquote>
<blockquote>
<p><strong>团队协作与沟通</strong>加强与团队成员、同事和合作伙伴的沟通，共同解决问题，提高团队的协同效率。积极主动承担责任，自己能够快速成长</p>
</blockquote>
<h3 id="第五周"><a href="#第五周" class="headerlink" title="第五周"></a>第五周</h3><p>接口测试。。</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240401142545601.png" srcset="/img/loading.gif" lazyload alt="image-20240401142545601"></p>
<p>怎么有两个t_user_extension</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240401150734601.png" srcset="/img/loading.gif" lazyload alt="image-20240401150734601"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240401161531467.png" srcset="/img/loading.gif" lazyload alt="image-20240401161531467"></p>
<p>同意MR</p>
<h6 id="-1"><a href="#-1" class="headerlink" title></a><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240401164214273.png" srcset="/img/loading.gif" lazyload alt="image-20240401164214273"></h6><p>准备测试</p>
<h5 id="user-api-项目改造"><a href="#user-api-项目改造" class="headerlink" title="user-api 项目改造"></a>user-api 项目改造</h5><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240402175501876.png" srcset="/img/loading.gif" lazyload alt="image-20240402175501876"></p>
<p>、</p>
<p>测试接口</p>
<p>看user-api的文件</p>
<p>user_extension 有分表？？？</p>
<p>不要过分相信copilot</p>
<p>写完后要有自己的思考</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240403160339310.png" srcset="/img/loading.gif" lazyload alt="image-20240403160339310"></p>
<p>出现这种情况，先 add，后commit，再pull；最后可以正常推code了</p>
<h4 id="navicat破解"><a href="#navicat破解" class="headerlink" title="navicat破解"></a>navicat破解</h4><p><a target="_blank" rel="noopener" href="https://github.com/LiJunYi2/navicat-keygen-16V/issues/6">Navicat Premium 16.2 现已正式发布 ,释放 Redis 全部潜能，keygen对其失效 · Issue #6 · LiJunYi2&#x2F;navicat-keygen-16V (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/LiJunYi2/navicat-keygen-16V/releases/tag/v16.1.15">Release 16.1.15 · LiJunYi2&#x2F;navicat-keygen-16V (github.com)</a></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240402222659415.png" srcset="/img/loading.gif" lazyload alt="image-20240402222659415"></p>
<p>小西科技二面</p>
<p>有的放矢 学东西</p>
<p>​	</p>
<h3 id="第六周"><a href="#第六周" class="headerlink" title="第六周"></a>第六周</h3><p>限流中间件的实现</p>
<p>小西科技二面</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240407150626033.png" srcset="/img/loading.gif" lazyload alt="image-20240407150626033"></p>
<p>502通常表示上游服务器返回了一个无效的响应，而504表示代理服务器在等待上游服务器响应时超时。</p>
<p>502  bad gateway </p>
<p>503 service not available 服务繁忙</p>
<p>504 gateway timeout 网关超时</p>
<p>ssl tls -&gt; https 	</p>
<p>会话秘钥</p>
<h4 id="todolist-2"><a href="#todolist-2" class="headerlink" title="todolist"></a>todolist</h4><ul>
<li><input disabled type="checkbox"> 接口更改</li>
<li><input disabled type="checkbox"> msg_center 吃透</li>
</ul>
<p>接口 更改 </p>
<ol>
<li><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240408144054642.png" srcset="/img/loading.gif" lazyload alt="image-20240408144054642"></li>
</ol>
<p>结果</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240408144825855.png" srcset="/img/loading.gif" lazyload alt="image-20240408144825855"></p>
<ol start="2">
<li><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240408153513773.png" srcset="/img/loading.gif" lazyload alt="image-20240408153513773"></li>
</ol>
<p>拉取代码后，在gitlab上有创建分支，但本地和gitlab没能同步;此时使用 <code>git fethch</code> 拉取远程的变化</p>
<p>yx_bullet的所有接口都没使用。。</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240408173841848.png" srcset="/img/loading.gif" lazyload alt="image-20240408173841848"></p>
<p>没权限</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240408175641106.png" srcset="/img/loading.gif" lazyload alt="image-20240408175641106"></p>
<h4 id="4-8"><a href="#4-8" class="headerlink" title="4.8"></a>4.8</h4><p>接口下线15+</p>
<h4 id="学习es"><a href="#学习es" class="headerlink" title="学习es"></a>学习es</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42393758/article/details/84581314">elasticsearch权威指南中文版 pdf和Elasticsearch顶尖高手系列-高手进阶篇资源分享_elasticsearch权威指南 pdf-CSDN博客</a></p>
<h4 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h4><p>无权限：study_sdk </p>
<p>online_data 不能创建 stable</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409102330419.png" srcset="/img/loading.gif" lazyload alt="image-20240409102330419"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409113823238.png" srcset="/img/loading.gif" lazyload alt="image-20240409113823238"></p>
<p>studnet_center_v2 增加灰度测试接口</p>
<p>熟悉业务逻辑</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409152604658.png" srcset="/img/loading.gif" lazyload alt="image-20240409152604658"></p>
<p>已下线</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409154413964.png" srcset="/img/loading.gif" lazyload alt="image-20240409154413964"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409154418555.png" srcset="/img/loading.gif" lazyload alt="image-20240409154418555"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409161041776.png" srcset="/img/loading.gif" lazyload alt="image-20240409161041776"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//灰度测试</span><br><span class="hljs-variable">$gray_test</span> = <span class="hljs-title class_">MdOfflineApi</span>::<span class="hljs-title function_ invoke__">checkGrayTest</span>(<span class="hljs-variable">$account_id</span>, <span class="hljs-string">&#x27;USER_COURSE_SERVICE&#x27;</span>)[<span class="hljs-string">&#x27;gray_test&#x27;</span>] ?? <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$gray_test</span>)&#123;<br>    <span class="hljs-variable">$role_list</span> = <span class="hljs-title class_">LibUserCourseApi</span>::<span class="hljs-title function_ invoke__">getUserAllRoleList</span>(<span class="hljs-variable">$account_id</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$role_list</span> = <span class="hljs-title class_">AccountApi</span>::<span class="hljs-title function_ invoke__">getUserAllRoleList</span>(<span class="hljs-variable">$account_id</span>);<br>&#125;<br></code></pre></td></tr></table></figure>





<p>撤回之前的一次提交</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git reset --soft HEAD^<br></code></pre></td></tr></table></figure>









<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409173428330.png" srcset="/img/loading.gif" lazyload alt="image-20240409173428330"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409181959419.png" srcset="/img/loading.gif" lazyload alt="image-20240409181959419"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409192900548.png" srcset="/img/loading.gif" lazyload alt="image-20240409192900548"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409201935824.png" srcset="/img/loading.gif" lazyload alt="image-20240409201935824"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240409204407112.png" srcset="/img/loading.gif" lazyload alt="image-20240409204407112"></p>
<h4 id="接口更改需求"><a href="#接口更改需求" class="headerlink" title="接口更改需求"></a>接口更改需求</h4><blockquote>
<p>用户课程系统：<br>git地址：<a target="_blank" rel="noopener" href="http://gitlab.yx/learning-business/user_course">http://gitlab.yx/learning-business/user_course</a><br>Jenkins：basic-be-usercourse<br>tag号：</p>
<p>账号系统：<br>git地址：<a target="_blank" rel="noopener" href="http://gitlab.yx/basic/account_v2.git">http://gitlab.yx/basic/account_v2.git</a><br>Jenkins：test-basic-be-accountv2、test-basic-be-accountv2crontab<br>tag号：</p>
<p>线下中间层：<br>git地址：<a target="_blank" rel="noopener" href="http://gitlab.yx/basic/offline_data_v2.git">http://gitlab.yx/basic/offline_data_v2.git</a><br>Jenkins：basic-be-offlinedatav2、basic-be-offlinedatav2kafka、basic-be-offlinedatav2crontab<br>tag号：</p>
<p>web端学生中心api：<br>git地址：<a target="_blank" rel="noopener" href="http://gitlab.yx/basic/student_center_v2.git">http://gitlab.yx/basic/student_center_v2.git</a><br>Jenkins：hzx-be-studentcenterv2<br>tag号：</p>
</blockquote>
<blockquote>
<p>用户课程系统：<br>1、新增 &#x2F;detail&#x2F;generateRoleInfo - 生成角色信息 接口<br>2、新增 &#x2F;detail&#x2F;updateRoleCourseState - 更新角色课程状态 接口<br>3、新增 &#x2F;detail&#x2F;getTopicUserInfo - 获取用户专题学习的角色信息 接口<br>4、新增 &#x2F;detail&#x2F;getRoleCourseInfo - 获取角色课程信息 接口<br>5、新增 &#x2F;detail&#x2F;getRoleInfo - 获取角色信息 接口<br>6、新增 &#x2F;detail&#x2F;getUserCourseList - 获取用户课程列表 接口<br>7、新增 &#x2F;detail&#x2F;getAccountId - 获取accountid 接口<br>8、新增 &#x2F;streamDdj&#x2F;getCourseListByDdjBatch - 获取打地基批次列表 接口<br>9、新增 &#x2F;streamDdj&#x2F;getBatchAccountCourseList - 获取打地基批次账号课程列表 接口<br>10、新增 &#x2F;streamDdj&#x2F;getBatchAccountCourseInfo - 获取打地基批次账号课程信息 接口<br>11、新增 &#x2F;streamDdj&#x2F;getUserLastUserCourseByLearnType - 获取用户最后一次课程信息 接口<br>12、新增 &#x2F;streamDdj&#x2F;restartDdj - 重启打地基 接口<br>13、新增 &#x2F;streamDdj&#x2F;updateCourseCompletedTime - 更新课程完成时间 接口</p>
<p>线下中间层：<br>1、系统、手动、切换模式等各种重启打地基<br>2、年级变更，通关证过期和不过期的场景<br>3、&#x2F;streamDdj&#x2F;ddjInfo - 打地基信息 接口，初始化通关证<br>4、各种类型、各种学科的课程分配，learn_type的值见：<a target="_blank" rel="noopener" href="http://gitlab.yx/yx_doc/student_center_doc">http://gitlab.yx/yx_doc/student_center_doc</a><br>5、课程完成时，更新课程完成时间<br>6、V1课程的开始学习链接<br>7、课程列表里面的错题本地址</p>
<p>web端学生中心api：<br>1、调整 &#x2F;statistic&#x2F;userHomeDatas - 首页用户学习历程 接口：调用账号系统的 &#x2F;course&#x2F;getUserCourse 接口 替换为用户课程系统的 &#x2F;detail&#x2F;getUserCourseList 接口<br>2、调整 &#x2F;statistic&#x2F;userStatisticDatas - 用户学习概览信息 接口：调用账号系统的 &#x2F;course&#x2F;getUserCourse 接口 替换为用户课程系统的 &#x2F;detail&#x2F;getUserCourseList 接口</p>
</blockquote>
<blockquote>
<p>这是提测邮件我目前整理到的相关的东西，你看看是否需要补充，然后再写下邮件，先保存到草稿箱，等我们这边完全好了，再发</p>
</blockquote>
<h4 id="tag"><a href="#tag" class="headerlink" title="tag"></a>tag</h4><blockquote>
<p>user_course_202404101355<br>offline_data_v2 提测的tag号</p>
</blockquote>
<p>提测邮件</p>
<ol>
<li>err问题</li>
<li>schooList接口问题</li>
</ol>
<p>代码review</p>
<p>检查之前的代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br><br><br>灰度测试<br>接口下线<br><br>	offline_data_v2 10个 <br>	student_center_v2 6个<br>	yx_bullet 6个<br><br>	pioneer_classba 1个<br>	pioneer_classba_pad 1个<br>	<br>	jupiter_en_pad 1个<br>	jupiter_en 1个<br>	<br>	en_reading 1个<br><br>		文档： https://b0mzss973k.feishu.cn/wiki/XsQ2wW1hAiaFjlkkFU1cOF7Pnwg<br>		https://b0mzss973k.feishu.cn/wiki/MPyBwsYiQizAWjkaWzvcj9YNnKh<br><br>		提测邮件 ：https://exmail.qq.com/cgi-bin/frame_html?sid=GVMhRGG82-rtxWUD,2&amp;sign_type=&amp;r=661184d94594ed348ef29c28691b91d9<br><br><br><br><br>		代码review 2h<br><br><br>		fix 提测总的 user <br><br></code></pre></td></tr></table></figure>









<p>无权限</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240412111758349.png" srcset="/img/loading.gif" lazyload alt="image-20240412111758349"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240412111859483.png" srcset="/img/loading.gif" lazyload alt="image-20240412111859483"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240412111915627.png" srcset="/img/loading.gif" lazyload alt="image-20240412111915627"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$gray_test</span> = <span class="hljs-title class_">MdOfflineApi</span>::<span class="hljs-title function_ invoke__">checkGrayTest</span>(<span class="hljs-variable">$account_id</span>, <span class="hljs-string">&#x27;USER_COURSE_SERVICE&#x27;</span>)[<span class="hljs-string">&#x27;gray_test&#x27;</span>] ?? <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$gray_test</span>)&#123;<br>    <span class="hljs-variable">$role_list</span> = <span class="hljs-title class_">LibUserCourseApi</span>::<span class="hljs-title function_ invoke__">getUserCourseList</span>(<span class="hljs-variable">$account_id</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$role_list</span> = <span class="hljs-title class_">AccountApi</span>::<span class="hljs-title function_ invoke__">getUserAllRoleList</span>(<span class="hljs-variable">$account_id</span>);<br>&#125;<br></code></pre></td></tr></table></figure>





<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#灰度测试</span><br>ACCOUNT_API_GET_USER_ID = <span class="hljs-variable">$&#123;ACCOUNT_API_PREFIX&#125;</span>/course/buyCourse<br>ACCOUNT_USER_COURSE_API = <span class="hljs-variable">$&#123;ACCOUNT_API_PREFIX&#125;</span>/detail/generateRoleInfo<br></code></pre></td></tr></table></figure>









<h3 id="第七周"><a href="#第七周" class="headerlink" title="第七周"></a>第七周</h3><p>git </p>
<p>落后是什么意思</p>
<p>workspace</p>
<p>stage</p>
<p>repository</p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240413192459459.png" srcset="/img/loading.gif" lazyload alt="image-20240413192459459"></p>
<p>git branch -b 	</p>
<p>git log –graph –oneline</p>
<p>git cat-file </p>
<p>git pull &#x3D;git fetch +git merge	</p>
<p>hash</p>
<ul>
<li>相同的输入 会 得到相同的输出</li>
<li>两个不同的输入会均匀的散列到输出域中</li>
<li>存在冲突（输入域远大于输出域）</li>
</ul>
<p>git merge </p>
<p>git rebase</p>
<p>git cherry-pick –continue –abort 	</p>
<p>git switch</p>
<p>git </p>
<p>事务如何 同时操作 多个实例</p>
<h4 id="todoList"><a href="#todoList" class="headerlink" title="todoList"></a>todoList</h4><ul>
<li><input disabled type="checkbox"> <a target="_blank" rel="noopener" href="https://b0mzss973k.feishu.cn/wiki/GVAewToHoi9Bz7kP2qwcQ8qUnVe">‍‌‍⁢⁡⁢⁤⁤⁡‬‍‬⁢‍⁢‬⁡﻿‍⁤⁢‌⁤⁢﻿﻿‍‬﻿‌‌⁡‍‍﻿‍⁤⁣‬⁢⁤重构项目回顾 - 飞书云文档 (feishu.cn)</a> 反思</li>
<li><input disabled type="checkbox"> <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000040321750">后端 - 分布式事务最经典的七种解决方案 - 分布式事务 - SegmentFault 思否</a> </li>
<li><input disabled type="checkbox"> <a target="_blank" rel="noopener" href="https://b0mzss973k.feishu.cn/wiki/TpVawthcwi7Zj2klEc6coyJAnLh?sheet=MTVvi4">‍‌⁢⁣⁣‌⁣⁤⁤‌⁣‍‍⁤‬‌⁤⁢⁡﻿‌⁢‬⁢‌⁤‍﻿⁡⁤⁤⁡‬⁡‍﻿⁤⁢⁢‍﻿‬⁤Copilot使用总结 - 飞书云文档 (feishu.cn)</a></li>
<li><input disabled type="checkbox"> msgCenter 代码解析</li>
<li><input checked disabled type="checkbox"> 发提测邮件</li>
<li><input checked disabled type="checkbox"> 开始第三期 php 代码修改 </li>
<li><input disabled type="checkbox"> 学习 php</li>
<li><input disabled type="checkbox"> 会议整理</li>
<li><input disabled type="checkbox"> 反思</li>
<li><input disabled type="checkbox"> 一次搞懂golang单机锁实现原理</li>
<li><input disabled type="checkbox"> 打地基项目熟悉，解决bug<br><a target="_blank" rel="noopener" href="https://www.tapd.cn/tapd_fe/61404088/bug/list?confId=1161404088001152309">https://www.tapd.cn/tapd_fe/61404088/bug/list?confId=1161404088001152309</a><br><a target="_blank" rel="noopener" href="http://wiki.classba.com.cn/pages/viewpage.action?pageId=52265103">http://wiki.classba.com.cn/pages/viewpage.action?pageId=52265103</a></li>
<li><input disabled type="checkbox"> go http超时控制问题；</li>
<li><input disabled type="checkbox"> 探针埋点 rpc、http、log封装；</li>
<li><input disabled type="checkbox"> 课程中心，没有带-be-要先完成新流程部署；</li>
<li><input disabled type="checkbox"> 周报</li>
<li><input disabled type="checkbox"> 写提测邮件</li>
<li><input disabled type="checkbox"> <a target="_blank" rel="noopener" href="https://b0mzss973k.feishu.cn/wiki/UevPwvOM4ibdNDkJWwQcorEDnKg">‌⁢⁡⁤‬‍⁣‌⁤⁡⁤⁢⁣⁡‍⁡⁢‬﻿‍‍‬‌‌⁢⁢‬⁤⁤⁣‍﻿﻿﻿⁡‬‬‌‍﻿﻿用户课程重构 - 飞书云文档 (feishu.cn)</a>、</li>
<li><input disabled type="checkbox"> 两个脚本</li>
<li><input disabled type="checkbox"> 更改 第四期</li>
<li><input disabled type="checkbox"> 第三期 提测邮件</li>
<li><input disabled type="checkbox"> 第二期 代码review</li>
<li><input disabled type="checkbox"> 月总结</li>
</ul>
<h4 id="重构总结"><a href="#重构总结" class="headerlink" title="重构总结"></a>重构总结</h4><p>优点：</p>
<p> 1、通过重构，加深了对业务的了解以及实现机制，后续对问题的定位会有帮助，不会出现一问三不知的情况</p>
<p> 2、通过重构，对接口的传参以及出参有了新的规范，减少了弱语言带来的一系列类型问题，经销商以及客户端的接受度会更高</p>
<p> 3、通过重构，优化了业务逻辑，减少不合理的业务逻辑</p>
<p> 4、减少了查询链路，接口响应及时</p>
<p>缺点：</p>
<p> 1、目前重构的框架，赋能目前比较少，缺少ES，rabbitmq，Kafka，Udp相关的基类，每个重构的项目都需要手动实现一遍，比较麻烦，且实现也不统一，出现问题，不能批量修复，只能单个项目单个排查。</p>
<p> 2、重构前期准备工作不足，功能点、影响范围、重构范围，实现方式等等都需要好好评估，进行中在调整，对排期影响很大</p>
<p> 3、排期不准确，测试周期不准确，三天开发两天测试，然后上线，到后面一周的开发，还是两天的测试上线。测试周期没有匹配上。尤其重点项目，排期更应合理一些，尤其逻辑相对复杂，接口比较复杂的。用户中心重构，光是注册和更新两个接口，测试就做了166个测试用例，总共242个测试用例，两天显然是不合理的。还有功能测试，回归，bug验证，灰度，数据校验等等。</p>
<p> 4、项目难度不一样，人员开发也不一样，建议项目重构还是要有老手介入，给出一些开发前的规范以及使用规则，而不是到了代码review再去调整</p>
<p> 5、开发结束就认定没啥事，改改bug即可，显然不适合重构项目，而且还要求一周上线的情况下</p>
<h4 id="lua"><a href="#lua" class="headerlink" title="lua"></a>lua</h4><p>Lua是一种简单而灵活的脚本语言，它的基本语法包括以下几个方面：</p>
<ol>
<li><strong>注释：</strong> Lua支持两种注释方式，单行注释以双连字符（<code>--</code>）开头，多行注释以<code>--[[</code>开头，以<code>]]</code>结尾。</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua">luaCopy code<span class="hljs-comment">-- 这是单行注释</span><br><br><span class="hljs-comment">--[[</span><br><span class="hljs-comment">这是</span><br><span class="hljs-comment">多行</span><br><span class="hljs-comment">注释</span><br><span class="hljs-comment">]]</span><br></code></pre></td></tr></table></figure>

<ol>
<li><strong>标识符：</strong> Lua的标识符由字母、数字和下划线组成，但不能以数字开头。</li>
<li><strong>变量：</strong> Lua中的变量无需声明类型，可以直接赋值使用。变量名区分大小写。</li>
</ol>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sqf">luaCopy codelocal <span class="hljs-built_in">name</span> = <span class="hljs-string">&quot;Lua&quot;</span><br><span class="hljs-keyword">local</span> <span class="hljs-built_in">count</span> = <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<ol>
<li><strong>数据类型：</strong> Lua支持多种数据类型，包括数字（number）、字符串（string）、布尔值（boolean）、表（table）、函数（function）、nil等。</li>
<li><strong>字符串：</strong> 字符串可以用单引号或双引号表示，也支持长字符串和转义字符。</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua">luaCopy codelocal str1 = <span class="hljs-string">&#x27;single quotes&#x27;</span><br><span class="hljs-keyword">local</span> str2 = <span class="hljs-string">&quot;double quotes&quot;</span><br><span class="hljs-keyword">local</span> longStr = <span class="hljs-string">[[</span><br><span class="hljs-string">    This is a long string</span><br><span class="hljs-string">    spanning multiple lines</span><br><span class="hljs-string">]]</span><br></code></pre></td></tr></table></figure>

<ol>
<li><strong>控制流：</strong> Lua支持常见的控制流结构，包括条件语句（if-elseif-else）、循环语句（while、for）、跳转语句（break、return）等。</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs lua">luaCopy codeif condition <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- code block</span><br><span class="hljs-keyword">elseif</span> anotherCondition <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- code block</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-comment">-- code block</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, <span class="hljs-number">10</span> <span class="hljs-keyword">do</span><br>    <span class="hljs-comment">-- code block</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">while</span> condition <span class="hljs-keyword">do</span><br>    <span class="hljs-comment">-- code block</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<ol>
<li><strong>函数：</strong> Lua中的函数可以通过<code>function</code>关键字定义，可以有多个返回值。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">luaCopy codelocal <span class="hljs-keyword">function</span> <span class="hljs-keyword">add</span>(a, b)<br>    <span class="hljs-keyword">return</span> a <span class="hljs-operator">+</span> b<br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">local</span> <span class="hljs-keyword">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">add</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)<br>print(<span class="hljs-keyword">result</span>)  <span class="hljs-comment">-- 输出 8</span><br></code></pre></td></tr></table></figure>

<ol>
<li><strong>表（table）：</strong> 表是Lua中的一种基本数据结构，类似于其他语言中的数组或字典，可以用来存储任意类型的值。</li>
</ol>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">luaCopy codelocal person = &#123;<br>    <span class="hljs-type">name</span> = &quot;John&quot;,<br>    age = <span class="hljs-number">30</span>,<br>    gender = &quot;male&quot;<br>&#125;<br><br>print(person.name)  <span class="hljs-comment">-- 输出 John</span><br></code></pre></td></tr></table></figure>

<p>这些是Lua语言的基本语法，掌握了这些基础内容就可以开始编写简单的Lua脚本了。</p>
<p>lua 脚本的格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">EVAL script numkeys key [key ...] arg [arg ...]<br></code></pre></td></tr></table></figure>







<p>使用 redis-go 实现 redis分布式锁</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> reLock<br><br><span class="hljs-keyword">import</span> (<br>   <span class="hljs-string">&quot;context&quot;</span><br>   <span class="hljs-string">&quot;errors&quot;</span><br>   <span class="hljs-string">&quot;github.com/go-redis/redis/v8&quot;</span><br>   <span class="hljs-string">&quot;strconv&quot;</span><br>   <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> DistributedLock <span class="hljs-keyword">struct</span> &#123;<br>   client        *redis.Client<br>   lockName      <span class="hljs-type">string</span><br>   lockDuration  time.Duration<br>   retryInterval time.Duration<br>   retryTimeout  time.Duration<br>   lockScript    *redis.Script<br>   unlockScript  *redis.Script<br>   ctx           context.Context<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDistributedLock</span><span class="hljs-params">(client *redis.Client, lockName <span class="hljs-type">string</span>, lockDuration, retryInterval, retryTimeout time.Duration)</span></span> *DistributedLock &#123;<br>   lockScript := redis.NewScript(<span class="hljs-string">`</span><br><span class="hljs-string">        if redis.call(&quot;EXISTS&quot;, KEYS[1]) == 0 then</span><br><span class="hljs-string">            redis.call(&quot;SET&quot;, KEYS[1], &quot;1&quot;)</span><br><span class="hljs-string">            redis.call(&quot;PEXPIRE&quot;, KEYS[1], ARGV[1])</span><br><span class="hljs-string">            return 1</span><br><span class="hljs-string">        end</span><br><span class="hljs-string">        return 0</span><br><span class="hljs-string">    `</span>)<br><br>   unlockScript := redis.NewScript(<span class="hljs-string">`</span><br><span class="hljs-string">        if redis.call(&quot;GET&quot;, KEYS[1]) == &quot;1&quot; then</span><br><span class="hljs-string">            return redis.call(&quot;DEL&quot;, KEYS[1])</span><br><span class="hljs-string">        end</span><br><span class="hljs-string">        return 0</span><br><span class="hljs-string">    `</span>)<br><br>   <span class="hljs-keyword">return</span> &amp;DistributedLock&#123;<br>      client:        client,<br>      lockName:      lockName,<br>      lockDuration:  lockDuration,<br>      retryInterval: retryInterval,<br>      retryTimeout:  retryTimeout,<br>      lockScript:    lockScript,<br>      unlockScript:  unlockScript,<br>      ctx:           context.Background(),<br>   &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *DistributedLock)</span></span> Lock() (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) &#123;<br>   start := time.Now()<br>   <span class="hljs-keyword">for</span> &#123;<br>      result, err := l.lockScript.Run(l.ctx, l.client, []<span class="hljs-type">string</span>&#123;l.lockName&#125;, l.lockDuration.Milliseconds()).Result()<br>      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, err<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> result == <span class="hljs-type">int64</span>(<span class="hljs-number">1</span>) &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span><br>      &#125;<br><br>      time.Sleep(l.retryInterval)<br><br>      <span class="hljs-keyword">if</span> time.Since(start) &gt; l.retryTimeout &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><br>      &#125;<br>   &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *DistributedLock)</span></span> Unlock() <span class="hljs-type">error</span> &#123;<br>   result, err := l.unlockScript.Run(l.ctx, l.client, []<span class="hljs-type">string</span>&#123;l.lockName&#125;, strconv.FormatInt(time.Now().UnixNano(), <span class="hljs-number">10</span>)).Result()<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      <span class="hljs-keyword">return</span> err<br>   &#125;<br><br>   <span class="hljs-keyword">if</span> result.(<span class="hljs-type">int64</span>) == <span class="hljs-type">int64</span>(<span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;unlock failed: lock has expired or value does not match&quot;</span>)<br>   &#125;<br><br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>







<p>（原本一条命令也是一个注释，不提供明确的需求和执行步骤，仅靠代码上下文和简单的命令）</p>
<h4 id="copilot总结"><a href="#copilot总结" class="headerlink" title="copilot总结"></a>copilot总结</h4><ol>
<li>php项目重构场景：使用php代码||json返回格式，生成代码</li>
</ol>
<p>2.第一个suggestion不一定是最好的，可以使用 alt + [ 和 ]</p>
<p>3.选中代码，可以右键查看 github copilot </p>
<p>4.当本地有登录github，其中jebranins系列，有时会自动去修改你的 userName&amp;&amp;token</p>
<p>5.强制性的指令 似乎用处不大</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run --<span class="hljs-built_in">rm</span> --name jaeger   -e COLLECTOR_ZIPKIN_HOST_PORT=:9411   -p 6831:6831/udp   -p 6832:6832/udp   -p 5778:5778   -p 16686:16<br>686   -p 4317:4317   -p 4318:4318   -p 14250:14250   -p 14268:14268   -p 14269:14269   -p 9411:9411   jaegertracing/all-in-one:1.55<br></code></pre></td></tr></table></figure>







<h4 id="重构第三期"><a href="#重构第三期" class="headerlink" title="重构第三期"></a>重构第三期</h4><p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240417205428225.png" srcset="/img/loading.gif" lazyload alt="image-20240417205428225"></p>
<p><img src="/2024/05/30/typora_files/%E6%80%BB%E7%BB%93/typora_files\总结.assets\image-20240418105135696.png" srcset="/img/loading.gif" lazyload alt="image-20240418105135696"></p>
<p>重构：</p>
<p>metrics log trace 微服务 分布式 容器</p>
<p>api -&gt; tracing </p>
<p>华为云 全链路应用性能管理服务  APM applicantion performance management</p>
<p>链路追踪</p>
<p>对某一个接口进行 事务分析</p>
<p>监控中间件的性能</p>
<p>实时报警</p>
<h3 id="第八周"><a href="#第八周" class="headerlink" title="第八周"></a>第八周</h3><h4 id="todoList-1"><a href="#todoList-1" class="headerlink" title="todoList"></a>todoList</h4><ul>
<li><input disabled type="checkbox"> 第二期 提测跟进</li>
<li><input disabled type="checkbox"> 第三期 写提测邮件</li>
<li><input disabled type="checkbox"> 第四期 改内容</li>
<li><input disabled type="checkbox"> 脚本两个</li>
</ul>
<p>扯皮</p>
<p>脚本</p>
<p>队列模型</p>
<p>TCC</p>
<p>2PC</p>
<p>生产阶段：需要捕获发送消息的错误，并重新发送</p>
<p>存储阶段：配置刷盘+复制的相关参数；消息写入多个副本的磁盘上，确保消息不回因为摸个broker宕机或磁盘损坏而丢失数据</p>
<p>消费阶段：处理完消费逻辑后，再发送消费确认</p>
<p>如何处理消费过程中重复的消息：</p>
<p>利用数据库的唯一性实现约束</p>
<p>设置前提条件</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div></div>
      <div>http://example.com/2024/05/30/typora_files/总结/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Forrest</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年5月30日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/05/30/typora_files/%E6%98%A5%E6%8B%9B/io.reader%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E9%97%AE%E9%A2%98/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/05/30/typora_files/Untitled%202/" title="">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
